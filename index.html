// CREATE ALL CHARTS
        function createAllCharts() {
            createOverviewChart();
            createTrendsChart();
            createPredictionsChart();
            createOptimizationChart();
            analyzeYesterday(); // Add yesterday analysis
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart AI Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 2rem 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
            to { box-shadow: 0 0 15px rgba(16, 185, 129, 0.8); }
        }

        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-dot {
            width: 0.5rem;
            height: 0.5rem;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            padding: 2rem 0;
        }



        .filters-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .filter-select, .filter-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .insights-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .insights-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .insights-card.green-flags {
            border-left: 4px solid #10b981;
        }

        .insights-card.red-flags {
            border-left: 4px solid #ef4444;
        }

        .insights-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .insights-title.green {
            color: #059669;
        }

        .insights-title.red {
            color: #dc2626;
        }

        .insight-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .insight-icon.green {
            background: #10b981;
        }

        .insight-icon.red {
            background: #ef4444;
        }

        .insight-icon.orange {
            background: #f59e0b;
        }

        .insight-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .insight-text strong {
            color: #1e293b;
        }

        .action-item {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
        }

        .action-item strong {
            color: #92400e;
        }

        .nav-tabs {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            padding: 0.75rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 1rem 1.75rem;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #fff, #f8fafc);
            color: #1e293b;
            box-shadow: 0 8px 32px rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-card.blue { border-left-color: #3b82f6; }
        .metric-card.green { border-left-color: #10b981; }
        .metric-card.purple { border-left-color: #8b5cf6; }
        .metric-card.orange { border-left-color: #f59e0b; }

        .metric-title {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .metric-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-change.positive { color: #059669; }
        .metric-change.negative { color: #dc2626; }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .chart-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-btn:hover, .chart-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .supplier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .supplier-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #e2e8f0;
            transition: all 0.2s;
        }

        .supplier-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .supplier-card.top-performer {
            border-left-color: #10b981;
        }

        .supplier-card.needs-attention {
            border-left-color: #f59e0b;
        }

        .supplier-card.underperforming {
            border-left-color: #ef4444;
        }

        .supplier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .supplier-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .supplier-score {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .supplier-score.excellent {
            background: #dcfce7;
            color: #166534;
        }

        .supplier-score.good {
            background: #fef3c7;
            color: #92400e;
        }

        .supplier-score.poor {
            background: #fecaca;
            color: #991b1b;
        }

        .supplier-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .supplier-stat {
            text-align: center;
        }

        .supplier-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        .supplier-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #64748b;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                padding: 1rem;
            }
            
            .chart-wrapper {
                height: 300px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .insights-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Smart AI Analytics Dashboard 
                <span class="ai-badge">
                    ü§ñ True AI
                </span>
            </h1>
            <div class="subtitle">
                <span id="summary-stats">Loading...</span>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="last-updated">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">


            <!-- Enhanced Smart Filters Section -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">üìÖ Date Range (WORKS!)</label>
                        <select class="filter-select" id="dateRange" onchange="applySmartFilters()">
                            <option value="all">All Time</option>
                            <option value="3">Last 3 Days</option>
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üéØ Performance Filter</label>
                        <select class="filter-select" id="performanceFilter" onchange="applySmartFilters()">
                            <option value="all">All Suppliers</option>
                            <option value="top-performers">Top Performers Only</option>
                            <option value="fast-growth">Fast Growing</option>
                            <option value="declining">Declining Performance</option>
                            <option value="inconsistent">Inconsistent Suppliers</option>
                            <option value="high-value">High Value Partners</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìä Minimum Bookings</label>
                        <input type="number" class="filter-input" id="minBookings" placeholder="e.g., 100" onchange="applySmartFilters()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üîç Supplier Search</label>
                        <input type="text" class="filter-input" id="supplierSearch" placeholder="Search suppliers..." oninput="applySmartFilters()">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn" onclick="resetAllFilters()">üîÑ Reset All</button>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 0.5rem; font-size: 0.875rem;">
                    <strong>ü§ñ Smart Filtering:</strong> <span id="filter-explanation">Showing all data. Apply filters to see dynamic analysis!</span>
                </div>
            </div>

            <!-- TRULY Smart AI Insights Section -->
            <div class="insights-section">
                <div class="insights-card green-flags">
                    <div class="insights-title green">
                        üöÄ Smart Opportunities & Growth Areas
                    </div>
                    <div id="green-insights">
                        <div class="loading">
                            <div class="spinner"></div>
                            Analyzing patterns with AI...
                        </div>
                    </div>
                </div>
                <div class="insights-card red-flags">
                    <div class="insights-title red">
                        ‚ö†Ô∏è Critical Issues & Action Items
                    </div>
                    <div id="red-insights">
                        <div class="loading">
                            <div class="spinner"></div>
                            Detecting problems and solutions...
                        </div>
                    </div>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="overview" onclick="switchTab('overview')">üìä Business Overview</button>
                <button class="nav-tab" data-tab="yesterday" onclick="switchTab('yesterday')">üìÖ Yesterday</button>
                <button class="nav-tab" data-tab="suppliers" onclick="switchTab('suppliers')">üéØ Smart Supplier Analysis</button>
                <button class="nav-tab" data-tab="trends" onclick="switchTab('trends')">üìà Trend Intelligence</button>
                <button class="nav-tab" data-tab="predictions" onclick="switchTab('predictions')">üîÆ AI Predictions</button>
                <button class="nav-tab" data-tab="optimization" onclick="switchTab('optimization')">‚ö° Optimization Hub</button>
            </nav>

            <!-- Business Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="metrics-grid">
                    <div class="metric-card blue">
                        <div class="metric-title">Total Bookings</div>
                        <div class="metric-value" id="total-bookings">Loading...</div>
                        <div class="metric-change positive" id="bookings-change">
                            ‚Üó Loading...
                        </div>
                    </div>
                    
                    <div class="metric-card green">
                        <div class="metric-title">Total GMV</div>
                        <div class="metric-value" id="total-gmv">Loading...</div>
                        <div class="metric-change positive" id="gmv-change">
                            ‚Üó Loading...
                        </div>
                    </div>
                    
                    <div class="metric-card purple">
                        <div class="metric-title">Avg Booking Value</div>
                        <div class="metric-value" id="avg-booking-value">Loading...</div>
                        <div class="metric-change" id="avg-change">Loading...</div>
                    </div>
                    
                    <div class="metric-card orange">
                        <div class="metric-title">Active Suppliers</div>
                        <div class="metric-value" id="active-suppliers">Loading...</div>
                        <div class="metric-change" id="suppliers-change">Loading...</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Daily Performance Trends (Filtered Data)</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="toggleChartType('line')">Line</button>
                            <button class="chart-btn" onclick="toggleChartType('bar')">Bar</button>
                            <button class="chart-btn" onclick="toggleChartMetric('bookings')">Bookings</button>
                            <button class="chart-btn" onclick="toggleChartMetric('gmv')">GMV</button>
                            <button class="chart-btn" onclick="toggleChartMetric('both')">Both</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Yesterday Analysis Tab -->
            <div id="yesterday" class="tab-content">
                <div class="metrics-grid">
                    <div class="metric-card blue">
                        <div class="metric-title">Yesterday's Bookings</div>
                        <div class="metric-value" id="yesterday-bookings">Loading...</div>
                        <div class="metric-change" id="yesterday-bookings-change">
                            Loading...
                        </div>
                    </div>
                    
                    <div class="metric-card green">
                        <div class="metric-title">Yesterday's GMV</div>
                        <div class="metric-value" id="yesterday-gmv">Loading...</div>
                        <div class="metric-change" id="yesterday-gmv-change">
                            Loading...
                        </div>
                    </div>
                    
                    <div class="metric-card purple">
                        <div class="metric-title">Avg Booking Value</div>
                        <div class="metric-value" id="yesterday-avg-value">Loading...</div>
                        <div class="metric-change" id="yesterday-avg-change">
                            Loading...
                        </div>
                    </div>
                    
                    <div class="metric-card orange">
                        <div class="metric-title">Active Suppliers</div>
                        <div class="metric-value" id="yesterday-suppliers">Loading...</div>
                        <div class="metric-change" id="yesterday-suppliers-change">
                            Loading...
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Yesterday vs Day Before Comparison</h3>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="yesterdayChart"></canvas>
                        </div>
                    </div>

                    <div class="insights-card">
                        <div class="insights-title" style="color: #3b82f6;">
                            üìä Yesterday's Highlights
                        </div>
                        <div id="yesterday-highlights">
                            <div class="loading">
                                <div class="spinner"></div>
                                Analyzing yesterday...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Top Performers Yesterday</h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="yesterdayTopPerformersChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Smart Supplier Analysis Tab -->
            <div id="suppliers" class="tab-content">
                <div id="supplier-grid" class="supplier-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Running smart supplier analysis...
                    </div>
                </div>
            </div>

            <!-- Trend Intelligence Tab -->
            <div id="trends" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">üß† Dynamic Trend Analysis</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="smartTrendFilter('smart-mix')">ü§ñ Smart Mix</button>
                            <button class="chart-btn" onclick="smartTrendFilter('top-performers')">‚≠ê Top Performers</button>
                            <button class="chart-btn" onclick="smartTrendFilter('growth-stories')">üìà Growth Stories</button>
                            <button class="chart-btn" onclick="smartTrendFilter('volatile-patterns')">‚ö° Volatile Patterns</button>
                            <button class="chart-btn" onclick="smartTrendFilter('recent-movers')">üî• Recent Movers</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="trendsChart"></canvas>
                    </div>
                    <div id="trend-explanation" style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; font-size: 0.875rem;">
                        AI will explain why these suppliers were selected and what patterns to watch...
                    </div>
                </div>
            </div>

            <!-- AI Predictions Tab -->
            <div id="predictions" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">üîÆ Real AI Performance Predictions</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="showRealPrediction('next-7-days')">üìÖ Next 7 Days</button>
                            <button class="chart-btn" onclick="showRealPrediction('growth-forecast')">üìä Growth Forecast</button>
                            <button class="chart-btn" onclick="showRealPrediction('seasonal-patterns')">üåä Seasonal Patterns</button>
                            <button class="chart-btn" onclick="showRealPrediction('supplier-outlook')">üéØ Supplier Outlook</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="predictionsChart"></canvas>
                    </div>
                    <div id="prediction-explanation" style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem; font-size: 0.875rem;">
                        <strong>ü§ñ AI Prediction Logic:</strong> <span id="prediction-reasoning">Loading prediction methodology...</span>
                    </div>
                </div>
            </div>

            <!-- Smart Optimization Hub Tab -->
            <div id="optimization" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">‚ö° Smart Optimization Matrix</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="showSmartOptimization('performance-matrix')">üìä Performance Matrix</button>
                            <button class="chart-btn" onclick="showSmartOptimization('efficiency-analysis')">‚ö° Efficiency Analysis</button>
                            <button class="chart-btn" onclick="showSmartOptimization('growth-potential')">üöÄ Growth Potential</button>
                            <button class="chart-btn" onclick="showSmartOptimization('risk-assessment')">‚ö†Ô∏è Risk Assessment</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="optimizationChart"></canvas>
                    </div>
                    <div id="optimization-insights" style="margin-top: 1rem;">
                        <!-- Dynamic optimization insights will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SECURITY CONFIGURATION
        const DASHBOARD_CONFIG = {
            requireAuth: true,
            password: "TravClan@1234", // Change this to your desired password
            sessionTimeout: 8 * 60 * 60 * 1000 // 8 hours
        };

        let isAuthenticated = false;

        // CORRECT COLUMN MAPPINGS
        const COLUMN_MAPPINGS = {
            name: 'name',
            date: 'booking_date (Date)',
            bookings: 'id',
            gmv: 'amount_in_inr'
        };

        // GLOBAL VARIABLES
        let rawBookingData = [];
        let processedData = {};
        let filteredData = {};
        let charts = {};
        let currentChartType = 'line';
        let currentMetric = 'bookings';
        let currentTrendFilter = 'smart-mix';
        let currentPredictionType = 'next-7-days';
        let currentOptimizationType = 'performance-matrix';
        let currentDateFilter = null;

        // LOGIN SYSTEM
        function showLoginScreen() {
            console.log('Showing login screen');
            
            // Hide the main dashboard content first
            document.querySelector('.main-content').style.display = 'none';
            
            const loginOverlay = document.createElement('div');
            loginOverlay.className = 'login-overlay';
            loginOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            loginOverlay.innerHTML = `
                <div style="
                    background: white;
                    padding: 3rem;
                    border-radius: 2rem;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    text-align: center;
                    max-width: 400px;
                    width: 90%;
                ">
                    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">
                        üîí Secure Access Required
                    </h2>
                    <p style="color: #64748b; margin-bottom: 2rem;">
                        Enter password to access the Analytics Dashboard
                    </p>
                    <div id="login-error" style="display: none; background: #fef2f2; color: #dc2626; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem;">
                    </div>
                    <input type="password" id="passwordInput" placeholder="Enter password" style="
                        width: 100%;
                        padding: 1rem;
                        border: 2px solid #e2e8f0;
                        border-radius: 0.75rem;
                        font-size: 1rem;
                        margin-bottom: 1rem;
                        transition: all 0.2s;
                    " onkeypress="if(event.key==='Enter') attemptLogin()">
                    <button onclick="attemptLogin()" style="
                        width: 100%;
                        padding: 1rem;
                        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                        color: white;
                        border: none;
                        border-radius: 0.75rem;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">üöÄ Access Dashboard</button>
                    <p style="font-size: 0.75rem; color: #64748b; margin-top: 1rem;">
                        Default password: analytics2025!
                    </p>
                </div>
            `;
            
            document.body.appendChild(loginOverlay);
        }

        function attemptLogin() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('login-error');
            
            console.log('Login attempt with password:', password);
            
            if (password === DASHBOARD_CONFIG.password) {
                console.log('Login successful');
                isAuthenticated = true;
                
                // Store session
                const session = {
                    loginTime: Date.now(),
                    expires: Date.now() + DASHBOARD_CONFIG.sessionTimeout
                };
                sessionStorage.setItem('dashboardSession', JSON.stringify(session));
                
                // Remove login overlay and show main content
                const overlay = document.querySelector('.login-overlay');
                if (overlay) overlay.remove();
                document.querySelector('.main-content').style.display = 'block';
                
                initializeDashboard();
                showSuccess('Welcome to Analytics Dashboard!');
            } else {
                console.log('Login failed');
                errorDiv.style.display = 'block';
                errorDiv.textContent = '‚ùå Invalid password. Please try again.';
                document.getElementById('passwordInput').value = '';
            }
        }

        function checkSession() {
            if (!DASHBOARD_CONFIG.requireAuth) return true;

            const sessionData = sessionStorage.getItem('dashboardSession');
            if (!sessionData) return false;

            try {
                const session = JSON.parse(sessionData);
                if (Date.now() > session.expires) {
                    sessionStorage.removeItem('dashboardSession');
                    return false;
                }
                
                isAuthenticated = true;
                return true;
            } catch (error) {
                sessionStorage.removeItem('dashboardSession');
                return false;
            }
        }

        function logout() {
            sessionStorage.removeItem('dashboardSession');
            location.reload();
        }

        // SMART LOAD AND PROCESS DATA
        async function loadBookingData() {
            try {
                console.log('Loading booking data with smart analysis...');
                showLoading();
                
                const possibleFiles = [
                    'Hotel API v2_Supplier Level_Pivot table 4.csv',
                    'booking-data.csv',
                    'booking-data-updated.csv',
                    'Hotel API v2_Supplier Level_Pivot table 2.csv'
                ];
                
                let response = null;
                let usedFile = '';
                
                for (const filename of possibleFiles) {
                    try {
                        response = await fetch(filename);
                        if (response.ok) {
                            usedFile = filename;
                            console.log(`Successfully found file: ${filename}`);
                            break;
                        }
                    } catch (e) {
                        console.log(`File ${filename} not found, trying next...`);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('No CSV file found. Please upload your CSV data.');
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false, // Keep as strings initially
                    complete: function(results) {
                        console.log('Raw CSV parsing results:', results);
                        
                        if (!results.data || results.data.length === 0) {
                            throw new Error('CSV file is empty or could not be parsed');
                        }
                        
                        // Filter out any completely empty rows
                        rawBookingData = results.data.filter(row => {
                            return row && typeof row === 'object' && Object.keys(row).length > 0 &&
                                   (row.name || row[COLUMN_MAPPINGS.name]) && 
                                   (row['booking_date (Date)'] || row[COLUMN_MAPPINGS.date]);
                        });
                        
                        console.log('Filtered booking data:', rawBookingData.length, 'valid rows');
                        console.log('Sample row:', rawBookingData[0]);
                        console.log('Available columns:', Object.keys(rawBookingData[0] || {}));
                        
                        if (rawBookingData.length === 0) {
                            throw new Error('No valid data rows found in CSV. Please check the file format.');
                        }
                        
                        processSmartData();
                        generateRealAIInsights();
                        applySmartFilters();
                        hideLoading();
                        showSuccess(`Smart analysis complete! Processed ${rawBookingData.length} rows from ${usedFile}`);
                    },
                    error: function(error) {
                        console.error('CSV parsing error:', error);
                        showError('Failed to parse CSV data: ' + error.message);
                        hideLoading();
                    }
                });
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load booking data. Please check that the CSV file exists.');
                hideLoading();
            }
        }

        // SMART DATA PROCESSING WITH AI ANALYSIS
        function processSmartData() {
            if (rawBookingData.length === 0) return;

            console.log('ü§ñ Processing data with smart algorithms...');

            const uniqueSuppliers = [...new Set(rawBookingData.map(row => row[COLUMN_MAPPINGS.name]))].filter(Boolean);
            const uniqueDates = [...new Set(rawBookingData.map(row => row[COLUMN_MAPPINGS.date]))].filter(Boolean);
            
            // Sort dates properly
            uniqueDates.sort((a, b) => new Date(a) - new Date(b));

            console.log(`Found ${uniqueSuppliers.length} suppliers and ${uniqueDates.length} dates`);

            const dailyTotals = {};
            const supplierData = {};
            const supplierTotals = {};
            const supplierMetrics = {}; // NEW: Advanced metrics

            // Initialize structures with null checks
            uniqueSuppliers.forEach(supplier => {
                if (supplier) {
                    supplierData[supplier] = {};
                    supplierTotals[supplier] = { bookings: 0, gmv: 0, days: 0 };
                    supplierMetrics[supplier] = {
                        dailyBookings: [],
                        weeklyTrends: [],
                        consistency: 0,
                        growthRate: 0,
                        volatility: 0,
                        efficiency: 0
                    };
                    
                    uniqueDates.forEach(date => {
                        if (date) {
                            supplierData[supplier][date] = { bookings: 0, gmv: 0 };
                        }
                    });
                }
            });

            uniqueDates.forEach(date => {
                if (date) {
                    dailyTotals[date] = { bookings: 0, gmv: 0 };
                }
            });

            // Process and aggregate data with better error handling
            rawBookingData.forEach((row, index) => {
                try {
                    const supplier = row[COLUMN_MAPPINGS.name];
                    const date = row[COLUMN_MAPPINGS.date];
                    const bookings = parseInt(row[COLUMN_MAPPINGS.bookings]) || 0;
                    const gmv = parseInt(row[COLUMN_MAPPINGS.gmv]) || 0;

                    if (supplier && date && supplierData[supplier] && supplierData[supplier][date]) {
                        supplierData[supplier][date].bookings += bookings;
                        supplierData[supplier][date].gmv += gmv;
                        
                        supplierTotals[supplier].bookings += bookings;
                        supplierTotals[supplier].gmv += gmv;
                        if (bookings > 0) supplierTotals[supplier].days += 1;

                        if (dailyTotals[date]) {
                            dailyTotals[date].bookings += bookings;
                            dailyTotals[date].gmv += gmv;
                        }
                    }
                } catch (error) {
                    console.warn(`Error processing row ${index}:`, error, row);
                }
            });

            // Calculate advanced metrics for each supplier
            uniqueSuppliers.forEach(supplier => {
                const dailyData = uniqueDates.map(date => supplierData[supplier][date].bookings);
                supplierMetrics[supplier].dailyBookings = dailyData;
                
                // Calculate consistency (coefficient of variation)
                const mean = dailyData.reduce((a, b) => a + b, 0) / dailyData.length;
                const variance = dailyData.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / dailyData.length;
                const stdDev = Math.sqrt(variance);
                supplierMetrics[supplier].consistency = mean > 0 ? 1 - (stdDev / mean) : 0;

                // Calculate growth rate (last week vs previous week)
                if (uniqueDates.length >= 14) {
                    const lastWeek = dailyData.slice(-7).reduce((a, b) => a + b, 0);
                    const prevWeek = dailyData.slice(-14, -7).reduce((a, b) => a + b, 0);
                    supplierMetrics[supplier].growthRate = prevWeek > 0 ? (lastWeek - prevWeek) / prevWeek : 0;
                }

                // Calculate volatility
                const changes = [];
                for (let i = 1; i < dailyData.length; i++) {
                    if (dailyData[i-1] > 0) {
                        changes.push(Math.abs((dailyData[i] - dailyData[i-1]) / dailyData[i-1]));
                    }
                }
                supplierMetrics[supplier].volatility = changes.length > 0 ? 
                    changes.reduce((a, b) => a + b, 0) / changes.length : 0;

                // Calculate efficiency (bookings per active day)
                supplierMetrics[supplier].efficiency = supplierTotals[supplier].days > 0 ? 
                    supplierTotals[supplier].bookings / supplierTotals[supplier].days : 0;
            });

            processedData = {
                suppliers: uniqueSuppliers,
                dates: uniqueDates,
                dailyTotals: dailyTotals,
                supplierData: supplierData,
                supplierTotals: supplierTotals,
                supplierMetrics: supplierMetrics // NEW!
            };

            filteredData = JSON.parse(JSON.stringify(processedData));
            console.log('ü§ñ Smart processing complete with advanced metrics!');
        }

        // REAL AI INSIGHTS GENERATION
        function generateRealAIInsights() {
            if (!processedData.supplierMetrics) return;

            console.log('ü§ñ Generating real AI insights...');

            const suppliers = Object.entries(processedData.supplierTotals);
            const greenFlags = [];
            const redFlags = [];

            suppliers.forEach(([name, totals]) => {
                const metrics = processedData.supplierMetrics[name];
                const avgBookingValue = totals.bookings > 0 ? totals.gmv / totals.bookings : 0;
                
                // SMART GREEN FLAGS - Real opportunities
                if (metrics.growthRate > 0.2 && totals.bookings > 500) {
                    greenFlags.push({
                        type: 'growth',
                        supplier: name,
                        message: `High growth partner (+${(metrics.growthRate * 100).toFixed(1)}% weekly) with strong volume`,
                        action: `ACTION: Negotiate better rates or increase marketing spend with ${name}`
                    });
                }

                if (metrics.consistency > 0.8 && metrics.efficiency > 30) {
                    greenFlags.push({
                        type: 'reliability',
                        supplier: name,
                        message: `Ultra-reliable performer: ${metrics.efficiency.toFixed(1)} bookings/day, ${(metrics.consistency * 100).toFixed(1)}% consistent`,
                        action: `ACTION: Consider ${name} for premium partnership or exclusive deals`
                    });
                }

                if (avgBookingValue > 3000 && totals.bookings > 200) {
                    greenFlags.push({
                        type: 'value',
                        supplier: name,
                        message: `High-value specialist: ‚Çπ${Math.round(avgBookingValue)} per booking with good volume`,
                        action: `ACTION: Focus premium inventory allocation on ${name}`
                    });
                }

                // SMART RED FLAGS - Real problems with solutions
                if (metrics.growthRate < -0.15 && totals.bookings > 100) {
                    redFlags.push({
                        type: 'decline',
                        supplier: name,
                        message: `Declining performance: ${(Math.abs(metrics.growthRate) * 100).toFixed(1)}% drop in recent bookings`,
                        action: `ACTION: Schedule review with ${name} - investigate pricing, inventory, or technical issues`
                    });
                }

                if (metrics.volatility > 0.5 && totals.bookings > 300) {
                    redFlags.push({
                        type: 'volatility',
                        supplier: name,
                        message: `Highly volatile: ${(metrics.volatility * 100).toFixed(1)}% daily variation suggests operational issues`,
                        action: `ACTION: Implement daily monitoring for ${name} and discuss stability improvements`
                    });
                }

                if (avgBookingValue < 800 && totals.bookings > 500) {
                    redFlags.push({
                        type: 'low-value',
                        supplier: name,
                        message: `Low value concern: ‚Çπ${Math.round(avgBookingValue)} avg despite high volume`,
                        action: `ACTION: Review ${name}'s commission structure or push for higher-value inventory`
                    });
                }

                if (totals.days < 10 && totals.bookings > 200) {
                    redFlags.push({
                        type: 'inconsistent',
                        supplier: name,
                        message: `Sporadic activity: ${totals.bookings} bookings across only ${totals.days} days`,
                        action: `ACTION: Investigate ${name}'s integration issues or seasonal patterns`
                    });
                }
            });

            // Sort by importance and limit
            greenFlags.sort((a, b) => {
                const priority = { growth: 3, reliability: 2, value: 1 };
                return (priority[b.type] || 0) - (priority[a.type] || 0);
            });

            redFlags.sort((a, b) => {
                const priority = { decline: 3, volatility: 2, 'low-value': 1, inconsistent: 1 };
                return (priority[b.type] || 0) - (priority[a.type] || 0);
            });

            updateRealInsightsDisplay(greenFlags.slice(0, 6), redFlags.slice(0, 6));
        }

        function updateRealInsightsDisplay(greenFlags, redFlags) {
            const greenContainer = document.getElementById('green-insights');
            const redContainer = document.getElementById('red-insights');

            // Green flags with actions
            greenContainer.innerHTML = '';
            if (greenFlags.length === 0) {
                greenContainer.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-icon green">‚úì</div>
                        <div class="insight-text">No major growth opportunities detected in current filter. Try expanding date range or reducing filters.</div>
                    </div>
                `;
            } else {
                greenFlags.forEach(insight => {
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-icon green">${insight.type === 'growth' ? 'üìà' : insight.type === 'reliability' ? '‚≠ê' : 'üíé'}</div>
                            <div class="insight-text">
                                <strong>${insight.supplier}:</strong> ${insight.message}
                                <div class="action-item">
                                    <strong>üí° ${insight.action}</strong>
                                </div>
                            </div>
                        </div>
                    `;
                    greenContainer.appendChild(item);
                });
            }

            // Red flags with solutions
            redContainer.innerHTML = '';
            if (redFlags.length === 0) {
                redContainer.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-icon green">‚úÖ</div>
                        <div class="insight-text">No critical issues detected in current data set! All suppliers performing within normal parameters.</div>
                    </div>
                `;
            } else {
                redFlags.forEach(insight => {
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-icon red">${insight.type === 'decline' ? 'üìâ' : insight.type === 'volatility' ? '‚ö°' : '‚ö†Ô∏è'}</div>
                            <div class="insight-text">
                                <strong>${insight.supplier}:</strong> ${insight.message}
                                <div class="action-item">
                                    <strong>üîß ${insight.action}</strong>
                                </div>
                            </div>
                        </div>
                    `;
                    redContainer.appendChild(item);
                });
            }
        }

        // SMART FILTERING SYSTEM
        function applySmartFilters() {
            const dateRange = document.getElementById('dateRange').value;
            const performanceFilter = document.getElementById('performanceFilter').value;
            const minBookings = parseInt(document.getElementById('minBookings').value) || 0;
            const supplierSearch = document.getElementById('supplierSearch').value.toLowerCase();

            console.log('ü§ñ Applying smart filters:', { dateRange, performanceFilter, minBookings, supplierSearch });

            let filtered = JSON.parse(JSON.stringify(processedData));
            let explanation = [];

            // Apply date range filter PROPERLY
            if (dateRange !== 'all') {
                const days = parseInt(dateRange);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                // Filter dates
                filtered.dates = filtered.dates.filter(date => new Date(date) >= cutoffDate);
                explanation.push(`üìÖ Last ${days} days`);
                
                // Recalculate daily totals for filtered dates
                const newDailyTotals = {};
                filtered.dates.forEach(date => {
                    newDailyTotals[date] = filtered.dailyTotals[date];
                });
                filtered.dailyTotals = newDailyTotals;

                // Recalculate supplier totals for filtered dates
                Object.keys(filtered.supplierTotals).forEach(supplier => {
                    let newBookings = 0;
                    let newGmv = 0;
                    let newDays = 0;

                    filtered.dates.forEach(date => {
                        if (filtered.supplierData[supplier][date]) {
                            newBookings += filtered.supplierData[supplier][date].bookings;
                            newGmv += filtered.supplierData[supplier][date].gmv;
                            if (filtered.supplierData[supplier][date].bookings > 0) newDays++;
                        }
                    });

                    filtered.supplierTotals[supplier] = {
                        bookings: newBookings,
                        gmv: newGmv,
                        days: newDays
                    };
                });

                currentDateFilter = days;
            } else {
                currentDateFilter = null;
            }

            // Apply performance filters INTELLIGENTLY
            if (performanceFilter !== 'all') {
                const allSuppliers = Object.entries(filtered.supplierTotals)
                    .map(([name, totals]) => ({
                        name,
                        totals,
                        metrics: filtered.supplierMetrics[name]
                    }));

                let selectedSuppliers = [];

                switch (performanceFilter) {
                    case 'top-performers':
                        selectedSuppliers = allSuppliers
                            .filter(s => s.totals.bookings > 100)
                            .sort((a, b) => b.totals.bookings - a.totals.bookings)
                            .slice(0, 10)
                            .map(s => s.name);
                        explanation.push(`‚≠ê Top 10 performers by volume`);
                        break;

                    case 'fast-growth':
                        selectedSuppliers = allSuppliers
                            .filter(s => s.metrics.growthRate > 0.1 && s.totals.bookings > 50)
                            .sort((a, b) => b.metrics.growthRate - a.metrics.growthRate)
                            .map(s => s.name);
                        explanation.push(`üìà Fast growing suppliers (+10%+ growth)`);
                        break;

                    case 'declining':
                        selectedSuppliers = allSuppliers
                            .filter(s => s.metrics.growthRate < -0.05 && s.totals.bookings > 50)
                            .sort((a, b) => a.metrics.growthRate - b.metrics.growthRate)
                            .map(s => s.name);
                        explanation.push(`üìâ Declining suppliers (-5%+ decline)`);
                        break;

                    case 'inconsistent':
                        selectedSuppliers = allSuppliers
                            .filter(s => s.metrics.consistency < 0.5 && s.totals.bookings > 100)
                            .sort((a, b) => a.metrics.consistency - b.metrics.consistency)
                            .map(s => s.name);
                        explanation.push(`‚ö° Inconsistent suppliers (high volatility)`);
                        break;

                    case 'high-value':
                        selectedSuppliers = allSuppliers
                            .filter(s => s.totals.bookings > 0)
                            .filter(s => (s.totals.gmv / s.totals.bookings) > 2500)
                            .sort((a, b) => (b.totals.gmv / b.totals.bookings) - (a.totals.gmv / a.totals.bookings))
                            .map(s => s.name);
                        explanation.push(`üíé High value partners (‚Çπ2500+ avg)`);
                        break;
                }

                filtered.suppliers = selectedSuppliers;
            }

            // Apply minimum bookings filter
            if (minBookings > 0) {
                filtered.suppliers = filtered.suppliers.filter(supplier => 
                    filtered.supplierTotals[supplier].bookings >= minBookings
                );
                explanation.push(`üìä Min ${minBookings} bookings`);
            }

            // Apply supplier search
            if (supplierSearch) {
                filtered.suppliers = filtered.suppliers.filter(supplier => 
                    supplier.toLowerCase().includes(supplierSearch)
                );
                explanation.push(`üîç "${supplierSearch}"`);
            }

            // Update filter explanation
            document.getElementById('filter-explanation').textContent = 
                explanation.length > 0 ? 
                `Filtering: ${explanation.join(', ')} ‚Üí ${filtered.suppliers.length} suppliers` :
                'Showing all data. Apply filters to see dynamic analysis!';

            filteredData = filtered;
            console.log('ü§ñ Smart filtering complete:', filtered.suppliers.length, 'suppliers');

            // Update all displays
            updateMetrics();
            createOverviewChart();
            createTrendsChart();
            createPredictionsChart();
            createOptimizationChart();
            analyzeYesterday();
            createSupplierCards();
            generateRealAIInsights(); // Regenerate insights for filtered data
        }

        function resetAllFilters() {
            document.getElementById('dateRange').value = 'all';
            document.getElementById('performanceFilter').value = 'all';
            document.getElementById('minBookings').value = '';
            document.getElementById('supplierSearch').value = '';
            applySmartFilters();
        }

        // ENHANCED METRICS WITH TREND CALCULATION
        function updateMetrics() {
            if (!filteredData.dailyTotals) return;

            let totalBookings = 0;
            let totalGMV = 0;

            Object.values(filteredData.dailyTotals).forEach(day => {
                totalBookings += day.bookings;
                totalGMV += day.gmv;
            });

            const activeSuppliers = filteredData.suppliers.length;
            const avgBookingValue = totalBookings > 0 ? Math.round(totalGMV / totalBookings) : 0;

            // Calculate REAL trends
            const dates = filteredData.dates.slice().sort((a, b) => new Date(a) - new Date(b));
            let bookingsTrend = 0;
            let gmvTrend = 0;
            let suppliersTrend = 0;

            if (dates.length >= 14) {
                // Compare last 7 days vs previous 7 days
                const last7 = dates.slice(-7);
                const prev7 = dates.slice(-14, -7);

                const last7Bookings = last7.reduce((sum, date) => sum + (filteredData.dailyTotals[date]?.bookings || 0), 0);
                const prev7Bookings = prev7.reduce((sum, date) => sum + (filteredData.dailyTotals[date]?.bookings || 0), 0);
                
                const last7GMV = last7.reduce((sum, date) => sum + (filteredData.dailyTotals[date]?.gmv || 0), 0);
                const prev7GMV = prev7.reduce((sum, date) => sum + (filteredData.dailyTotals[date]?.gmv || 0), 0);

                bookingsTrend = prev7Bookings > 0 ? ((last7Bookings - prev7Bookings) / prev7Bookings * 100) : 0;
                gmvTrend = prev7GMV > 0 ? ((last7GMV - prev7GMV) / prev7GMV * 100) : 0;
                
                // Count active suppliers in each period
                const last7Suppliers = new Set();
                const prev7Suppliers = new Set();
                
                last7.forEach(date => {
                    filteredData.suppliers.forEach(supplier => {
                        if (filteredData.supplierData[supplier][date]?.bookings > 0) {
                            last7Suppliers.add(supplier);
                        }
                    });
                });
                
                prev7.forEach(date => {
                    filteredData.suppliers.forEach(supplier => {
                        if (filteredData.supplierData[supplier][date]?.bookings > 0) {
                            prev7Suppliers.add(supplier);
                        }
                    });
                });

                suppliersTrend = prev7Suppliers.size > 0 ? 
                    ((last7Suppliers.size - prev7Suppliers.size) / prev7Suppliers.size * 100) : 0;
            }

            // Update DOM
            document.getElementById('total-bookings').textContent = totalBookings.toLocaleString();
            document.getElementById('total-gmv').textContent = '‚Çπ' + (totalGMV / 10000000).toFixed(2) + 'Cr';
            document.getElementById('avg-booking-value').textContent = '‚Çπ' + avgBookingValue.toLocaleString();
            document.getElementById('active-suppliers').textContent = activeSuppliers;

            // Update trend indicators with real calculations
            document.getElementById('bookings-change').textContent = 
                `${bookingsTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(bookingsTrend).toFixed(1)}% vs last week`;
            document.getElementById('bookings-change').className = 
                `metric-change ${bookingsTrend >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('gmv-change').textContent = 
                `${gmvTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(gmvTrend).toFixed(1)}% vs last week`;
            document.getElementById('gmv-change').className = 
                `metric-change ${gmvTrend >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('suppliers-change').textContent = 
                suppliersTrend !== 0 ? 
                `${suppliersTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(suppliersTrend).toFixed(1)}% active` :
                '‚Üí Stable count';

            document.getElementById('summary-stats').textContent = 
                `${totalBookings.toLocaleString()} bookings ‚Ä¢ ‚Çπ${(totalGMV / 10000000).toFixed(2)}Cr GMV ‚Ä¢ ${activeSuppliers} suppliers`;

            document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleString();
        }

        // YESTERDAY ANALYSIS
        function analyzeYesterday() {
            if (!processedData.dailyTotals || !processedData.dates.length) return;

            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const dayBeforeYesterday = new Date(today);
            dayBeforeYesterday.setDate(today.getDate() - 2);

            const yesterdayStr = formatDateForData(yesterday);
            const dayBeforeStr = formatDateForData(dayBeforeYesterday);

            console.log('Looking for yesterday data:', yesterdayStr);
            console.log('Looking for day before data:', dayBeforeStr);

            // Get yesterday's data
            const yesterdayData = processedData.dailyTotals[yesterdayStr] || { bookings: 0, gmv: 0 };
            const dayBeforeData = processedData.dailyTotals[dayBeforeStr] || { bookings: 0, gmv: 0 };

            // Calculate changes
            const bookingsChange = dayBeforeData.bookings > 0 ? 
                ((yesterdayData.bookings - dayBeforeData.bookings) / dayBeforeData.bookings * 100) : 0;
            const gmvChange = dayBeforeData.gmv > 0 ? 
                ((yesterdayData.gmv - dayBeforeData.gmv) / dayBeforeData.gmv * 100) : 0;

            // Calculate average booking value
            const yesterdayAvgValue = yesterdayData.bookings > 0 ? yesterdayData.gmv / yesterdayData.bookings : 0;
            const dayBeforeAvgValue = dayBeforeData.bookings > 0 ? dayBeforeData.gmv / dayBeforeData.bookings : 0;
            const avgValueChange = dayBeforeAvgValue > 0 ? 
                ((yesterdayAvgValue - dayBeforeAvgValue) / dayBeforeAvgValue * 100) : 0;

            // Count active suppliers
            const yesterdaySuppliers = processedData.suppliers.filter(supplier => 
                processedData.supplierData[supplier][yesterdayStr]?.bookings > 0
            ).length;
            const dayBeforeSuppliers = processedData.suppliers.filter(supplier => 
                processedData.supplierData[supplier][dayBeforeStr]?.bookings > 0
            ).length;
            const suppliersChange = dayBeforeSuppliers > 0 ? 
                ((yesterdaySuppliers - dayBeforeSuppliers) / dayBeforeSuppliers * 100) : 0;

            // Update metrics
            document.getElementById('yesterday-bookings').textContent = yesterdayData.bookings.toLocaleString();
            document.getElementById('yesterday-gmv').textContent = '‚Çπ' + (yesterdayData.gmv / 10000000).toFixed(2) + 'Cr';
            document.getElementById('yesterday-avg-value').textContent = '‚Çπ' + Math.round(yesterdayAvgValue).toLocaleString();
            document.getElementById('yesterday-suppliers').textContent = yesterdaySuppliers;

            // Update change indicators
            updateChangeIndicator('yesterday-bookings-change', bookingsChange, 'vs day before');
            updateChangeIndicator('yesterday-gmv-change', gmvChange, 'vs day before');
            updateChangeIndicator('yesterday-avg-change', avgValueChange, 'vs day before');
            updateChangeIndicator('yesterday-suppliers-change', suppliersChange, 'suppliers vs day before');

            // Generate insights
            generateYesterdayInsights(yesterdayStr, dayBeforeStr, {
                yesterday: yesterdayData,
                dayBefore: dayBeforeData,
                bookingsChange,
                gmvChange,
                avgValueChange,
                suppliersChange
            });

            // Create charts
            createYesterdayCharts(yesterdayStr, dayBeforeStr);
        }

        function formatDateForData(date) {
            // Try different date formats to match your data
            const formats = [
                date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                date.toLocaleDateString('en-US'),
                date.toISOString().split('T')[0],
                date.getMonth() + 1 + '/' + date.getDate() + '/' + date.getFullYear(),
                (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear()
            ];

            // Find which format exists in your data
            for (const format of formats) {
                if (processedData.dailyTotals[format]) {
                    return format;
                }
            }

            // If none found, return the first format
            return formats[0];
        }

        function updateChangeIndicator(elementId, change, suffix) {
            const element = document.getElementById(elementId);
            const arrow = change >= 0 ? '‚Üó' : '‚Üò';
            const className = change >= 0 ? 'metric-change positive' : 'metric-change negative';
            
            element.textContent = `${arrow} ${Math.abs(change).toFixed(1)}% ${suffix}`;
            element.className = className;
        }

        function generateYesterdayInsights(yesterdayStr, dayBeforeStr, metrics) {
            const container = document.getElementById('yesterday-highlights');
            const insights = [];

            // Performance insights
            if (metrics.bookingsChange > 10) {
                insights.push(`üöÄ Strong day! ${metrics.bookingsChange.toFixed(1)}% more bookings than day before`);
            } else if (metrics.bookingsChange < -10) {
                insights.push(`üìâ Slow day: ${Math.abs(metrics.bookingsChange).toFixed(1)}% fewer bookings`);
            } else {
                insights.push(`üìä Steady performance: ${Math.abs(metrics.bookingsChange).toFixed(1)}% change in bookings`);
            }

            // GMV insights
            if (metrics.gmvChange > 15) {
                insights.push(`üí∞ Revenue surge: +${metrics.gmvChange.toFixed(1)}% GMV increase`);
            } else if (metrics.gmvChange < -15) {
                insights.push(`‚ö†Ô∏è Revenue dip: ${Math.abs(metrics.gmvChange).toFixed(1)}% GMV decrease`);
            }

            // Average value insights
            if (metrics.avgValueChange > 5) {
                insights.push(`üìà Higher value bookings: +${metrics.avgValueChange.toFixed(1)}% avg value`);
            } else if (metrics.avgValueChange < -5) {
                insights.push(`üìâ Lower value bookings: ${Math.abs(metrics.avgValueChange).toFixed(1)}% avg value drop`);
            }

            // Supplier insights
            if (metrics.suppliersChange > 0) {
                insights.push(`üéØ More suppliers active: +${metrics.suppliersChange.toFixed(1)}%`);
            } else if (metrics.suppliersChange < -5) {
                insights.push(`‚ö†Ô∏è Fewer suppliers active: ${Math.abs(metrics.suppliersChange).toFixed(1)}% decrease`);
            }

            // Top performer analysis
            const topYesterday = findTopPerformerYesterday(yesterdayStr);
            if (topYesterday) {
                insights.push(`‚≠ê Top performer: ${topYesterday.name} with ${topYesterday.bookings} bookings`);
            }

            // Display insights
            container.innerHTML = insights.length > 0 ? 
                insights.map(insight => `<div style="padding: 0.5rem 0; border-bottom: 1px solid #f1f5f9;">${insight}</div>`).join('') :
                '<div>No significant changes detected from previous day.</div>';
        }

        function findTopPerformerYesterday(yesterdayStr) {
            let topPerformer = null;
            let maxBookings = 0;

            processedData.suppliers.forEach(supplier => {
                const bookings = processedData.supplierData[supplier][yesterdayStr]?.bookings || 0;
                if (bookings > maxBookings) {
                    maxBookings = bookings;
                    topPerformer = { name: supplier, bookings };
                }
            });

            return topPerformer;
        }

        function createYesterdayCharts(yesterdayStr, dayBeforeStr) {
            createYesterdayComparisonChart(yesterdayStr, dayBeforeStr);
            createYesterdayTopPerformersChart(yesterdayStr);
        }

        function createYesterdayComparisonChart(yesterdayStr, dayBeforeStr) {
            const ctx = document.getElementById('yesterdayChart').getContext('2d');
            
            if (charts.yesterday) {
                charts.yesterday.destroy();
            }

            const yesterdayData = processedData.dailyTotals[yesterdayStr] || { bookings: 0, gmv: 0 };
            const dayBeforeData = processedData.dailyTotals[dayBeforeStr] || { bookings: 0, gmv: 0 };

            charts.yesterday = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Day Before Yesterday', 'Yesterday'],
                    datasets: [
                        {
                            label: 'Bookings',
                            data: [dayBeforeData.bookings, yesterdayData.bookings],
                            backgroundColor: ['#94a3b8', '#3b82f6'],
                            borderColor: ['#64748b', '#2563eb'],
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'GMV (‚Çπ Lakhs)',
                            data: [dayBeforeData.gmv / 100000, yesterdayData.gmv / 100000],
                            backgroundColor: ['#a3a3a3', '#10b981'],
                            borderColor: ['#737373', '#059669'],
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: { display: true, text: 'Bookings' }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            title: { display: true, text: 'GMV (‚Çπ Lakhs)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function createYesterdayTopPerformersChart(yesterdayStr) {
            const ctx = document.getElementById('yesterdayTopPerformersChart').getContext('2d');
            
            if (charts.yesterdayTop) {
                charts.yesterdayTop.destroy();
            }

            // Get top 10 performers from yesterday
            const topPerformers = processedData.suppliers
                .map(supplier => ({
                    name: supplier,
                    bookings: processedData.supplierData[supplier][yesterdayStr]?.bookings || 0,
                    gmv: processedData.supplierData[supplier][yesterdayStr]?.gmv || 0
                }))
                .filter(s => s.bookings > 0)
                .sort((a, b) => b.bookings - a.bookings)
                .slice(0, 10);

            if (topPerformers.length === 0) {
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No data available for yesterday', ctx.canvas.width/2, ctx.canvas.height/2);
                return;
            }

            charts.yesterdayTop = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: topPerformers.map(s => s.name),
                    datasets: [{
                        label: 'Yesterday\'s Bookings',
                        data: topPerformers.map(s => s.bookings),
                        backgroundColor: topPerformers.map((_, i) => {
                            const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'];
                            return colors[i % colors.length];
                        }),
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true },
                        y: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function createOverviewChart() {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            
            if (charts.overview) {
                charts.overview.destroy();
            }

            if (!filteredData.dailyTotals || filteredData.dates.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No data for current filters', ctx.canvas.width/2, ctx.canvas.height/2);
                return;
            }

            const labels = filteredData.dates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const bookingsData = filteredData.dates.map(date => filteredData.dailyTotals[date].bookings);
            const gmvData = filteredData.dates.map(date => filteredData.dailyTotals[date].gmv / 100000);

            let datasets = [];
            
            if (currentMetric === 'bookings' || currentMetric === 'both') {
                datasets.push({
                    label: 'Total Bookings',
                    data: bookingsData,
                    borderColor: '#3b82f6',
                    backgroundColor: currentChartType === 'bar' ? '#3b82f6' : 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: currentChartType === 'line',
                    yAxisID: 'y'
                });
            }

            if (currentMetric === 'gmv' || currentMetric === 'both') {
                datasets.push({
                    label: 'GMV (‚Çπ Lakhs)',
                    data: gmvData,
                    borderColor: '#10b981',
                    backgroundColor: currentChartType === 'bar' ? '#10b981' : 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: currentMetric === 'both' ? 'y1' : 'y'
                });
            }

            charts.overview = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: currentMetric === 'both' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            position: 'left'
                        },
                        y1: currentMetric === 'both' ? {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        } : {},
                        x: { grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        // SMART TRENDS CHART WITH DYNAMIC SUPPLIER SELECTION
        function createTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (charts.trends) {
                charts.trends.destroy();
            }

            if (!filteredData.supplierData || filteredData.suppliers.length === 0) return;

            let suppliersToShow = [];
            let explanation = "";

            switch (currentTrendFilter) {
                case 'smart-mix':
                    // AI-selected mix: top performers + growth stories + interesting patterns
                    const allSuppliers = Object.entries(filteredData.supplierTotals)
                        .filter(([name]) => filteredData.suppliers.includes(name))
                        .map(([name, totals]) => ({
                            name,
                            totals,
                            metrics: filteredData.supplierMetrics[name]
                        }));

                    // Get top 2 performers
                    const topPerformers = allSuppliers
                        .sort((a, b) => b.totals.bookings - a.totals.bookings)
                        .slice(0, 2);

                    // Get fastest growing
                    const fastGrowing = allSuppliers
                        .filter(s => s.metrics.growthRate > 0.1 && s.totals.bookings > 100)
                        .sort((a, b) => b.metrics.growthRate - a.metrics.growthRate)
                        .slice(0, 2);

                    // Get most volatile (interesting patterns)
                    const volatile = allSuppliers
                        .filter(s => s.metrics.volatility > 0.3 && s.totals.bookings > 200)
                        .filter(s => !topPerformers.includes(s) && !fastGrowing.includes(s))
                        .sort((a, b) => b.metrics.volatility - a.metrics.volatility)
                        .slice(0, 2);

                    suppliersToShow = [...topPerformers, ...fastGrowing, ...volatile]
                        .map(s => s.name);
                    
                    explanation = `ü§ñ AI Selected: ${topPerformers.length} top performers + ${fastGrowing.length} fast growers + ${volatile.length} volatile patterns`;
                    break;

                case 'top-performers':
                    suppliersToShow = Object.entries(filteredData.supplierTotals)
                        .filter(([name]) => filteredData.suppliers.includes(name))
                        .sort((a, b) => b[1].bookings - a[1].bookings)
                        .slice(0, 8)
                        .map(([name]) => name);
                    explanation = "‚≠ê Top 8 suppliers by total booking volume";
                    break;

                case 'growth-stories':
                    suppliersToShow = Object.entries(filteredData.supplierTotals)
                        .filter(([name]) => filteredData.suppliers.includes(name))
                        .filter(([name, totals]) => filteredData.supplierMetrics[name].growthRate > 0.05 && totals.bookings > 50)
                        .sort((a, b) => filteredData.supplierMetrics[b[0]].growthRate - filteredData.supplierMetrics[a[0]].growthRate)
                        .slice(0, 8)
                        .map(([name]) => name);
                    explanation = "üìà Fastest growing suppliers (5%+ weekly growth)";
                    break;

                case 'volatile-patterns':
                    suppliersToShow = Object.entries(filteredData.supplierTotals)
                        .filter(([name]) => filteredData.suppliers.includes(name))
                        .filter(([name, totals]) => filteredData.supplierMetrics[name].volatility > 0.25 && totals.bookings > 100)
                        .sort((a, b) => filteredData.supplierMetrics[b[0]].volatility - filteredData.supplierMetrics[a[0]].volatility)
                        .slice(0, 8)
                        .map(([name]) => name);
                    explanation = "‚ö° Most volatile suppliers (unstable booking patterns)";
                    break;

                case 'recent-movers':
                    // Suppliers with significant changes in last 7 days
                    if (filteredData.dates.length >= 14) {
                        const recent7 = filteredData.dates.slice(-7);
                        const previous7 = filteredData.dates.slice(-14, -7);
                        
                        suppliersToShow = Object.entries(filteredData.supplierTotals)
                            .filter(([name]) => filteredData.suppliers.includes(name))
                            .map(([name, totals]) => {
                                const recentSum = recent7.reduce((sum, date) => 
                                    sum + (filteredData.supplierData[name][date]?.bookings || 0), 0);
                                const previousSum = previous7.reduce((sum, date) => 
                                    sum + (filteredData.supplierData[name][date]?.bookings || 0), 0);
                                
                                const change = previousSum > 0 ? (recentSum - previousSum) / previousSum : 0;
                                return { name, change: Math.abs(change), totals };
                            })
                            .filter(s => s.change > 0.2 && s.totals.bookings > 50)
                            .sort((a, b) => b.change - a.change)
                            .slice(0, 8)
                            .map(s => s.name);
                        explanation = "üî• Biggest week-over-week changes (20%+ movement)";
                    } else {
                        suppliersToShow = Object.entries(filteredData.supplierTotals)
                            .filter(([name]) => filteredData.suppliers.includes(name))
                            .sort((a, b) => b[1].bookings - a[1].bookings)
                            .slice(0, 6)
                            .map(([name]) => name);
                        explanation = "üî• Top performers (need more data for recent movers analysis)";
                    }
                    break;
            }

            // Update explanation
            document.getElementById('trend-explanation').innerHTML = `
                <strong>ü§ñ AI Analysis:</strong> ${explanation}<br>
                <strong>Selected Suppliers:</strong> ${suppliersToShow.join(', ')}<br>
                <strong>Date Range:</strong> ${filteredData.dates.length} days${currentDateFilter ? ` (filtered to last ${currentDateFilter} days)` : ''}
            `;

            if (suppliersToShow.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No suppliers match current criteria', ctx.canvas.width/2, ctx.canvas.height/2);
                return;
            }

            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', 
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
            ];

            const datasets = suppliersToShow.map((supplier, index) => {
                const data = filteredData.dates.map(date => filteredData.supplierData[supplier][date]?.bookings || 0);
                const metrics = filteredData.supplierMetrics[supplier];
                
                // Dynamic line styling based on supplier characteristics
                let borderWidth = 2;
                let borderDash = undefined;
                let tension = 0.1;
                
                if (metrics.growthRate > 0.1) borderWidth = 3; // Thicker for growth
                if (metrics.volatility > 0.4) borderDash = [5, 5]; // Dashed for volatile
                if (metrics.consistency > 0.8) tension = 0.4; // Smoother for consistent
                
                return {
                    label: `${supplier} ${metrics.growthRate > 0.1 ? 'üìà' : metrics.growthRate < -0.1 ? 'üìâ' : ''}${metrics.volatility > 0.4 ? '‚ö°' : ''}`,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: borderWidth,
                    borderDash: borderDash,
                    fill: false,
                    tension: tension
                };
            });

            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.dates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        // REAL AI PREDICTIONS
        function createPredictionsChart() {
            const ctx = document.getElementById('predictionsChart').getContext('2d');
            
            if (charts.predictions) {
                charts.predictions.destroy();
            }

            if (!filteredData.dailyTotals || filteredData.dates.length < 7) {
                ctx.fillStyle = '#64748b';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Need at least 7 days of data for predictions', ctx.canvas.width/2, ctx.canvas.height/2);
                return;
            }

            let labels = [];
            let datasets = [];
            let reasoning = "";

            switch (currentPredictionType) {
                case 'next-7-days':
                    const recentData = filteredData.dates.slice(-14).map(date => filteredData.dailyTotals[date].bookings);
                    
                    // Calculate trend using linear regression
                    const n = recentData.length;
                    const x = Array.from({length: n}, (_, i) => i);
                    const sumX = x.reduce((a, b) => a + b, 0);
                    const sumY = recentData.reduce((a, b) => a + b, 0);
                    const sumXY = x.map((xi, i) => xi * recentData[i]).reduce((a, b) => a + b, 0);
                    const sumXX = x.map(xi => xi * xi).reduce((a, b) => a + b, 0);
                    
                    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                    const intercept = (sumY - slope * sumX) / n;

                    // Add day-of-week seasonality
                    const dayOfWeekAvg = new Array(7).fill(0);
                    const dayOfWeekCount = new Array(7).fill(0);
                    
                    filteredData.dates.forEach((date, index) => {
                        const dayOfWeek = new Date(date).getDay();
                        const bookings = filteredData.dailyTotals[date].bookings;
                        dayOfWeekAvg[dayOfWeek] += bookings;
                        dayOfWeekCount[dayOfWeek]++;
                    });
                    
                    for (let i = 0; i < 7; i++) {
                        if (dayOfWeekCount[i] > 0) {
                            dayOfWeekAvg[i] /= dayOfWeekCount[i];
                        }
                    }
                    
                    const overallAvg = recentData.reduce((a, b) => a + b, 0) / recentData.length;
                    const seasonalMultipliers = dayOfWeekAvg.map(avg => avg > 0 ? avg / overallAvg : 1);

                    // Generate predictions
                    const predictions = [];
                    const today = new Date(Math.max(...filteredData.dates.map(d => new Date(d))));
                    
                    labels = ['Today'];
                    for (let i = 1; i <= 7; i++) {
                        const futureDate = new Date(today);
                        futureDate.setDate(today.getDate() + i);
                        labels.push(futureDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                        
                        const basePrediction = intercept + slope * (n + i);
                        const dayOfWeek = futureDate.getDay();
                        const seasonalPrediction = basePrediction * seasonalMultipliers[dayOfWeek];
                        predictions.push(Math.max(0, Math.round(seasonalPrediction)));
                    }

                    datasets = [
                        {
                            label: 'Historical (Last 14 Days)',
                            data: [recentData[recentData.length - 1], ...Array(7).fill(null)],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'AI Prediction',
                            data: [recentData[recentData.length - 1], ...predictions],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            fill: false
                        }
                    ];

                    reasoning = `Using linear regression on last ${n} days (trend: ${slope > 0 ? '+' : ''}${slope.toFixed(2)} bookings/day) combined with day-of-week seasonality patterns. Confidence: ${slope !== 0 ? 'Medium' : 'Low'} (${Math.abs(slope) > 5 ? 'strong' : 'weak'} trend detected)`;
                    break;

                case 'growth-forecast':
                    // Weekly growth forecast for next 4 weeks
                    const weeklyData = [];
                    for (let i = 0; i < Math.floor(filteredData.dates.length / 7); i++) {
                        const weekStart = i * 7;
                        const weekEnd = Math.min(weekStart + 7, filteredData.dates.length);
                        const weekDates = filteredData.dates.slice(weekStart, weekEnd);
                        const weekTotal = weekDates.reduce((sum, date) => sum + filteredData.dailyTotals[date].bookings, 0);
                        weeklyData.push(weekTotal);
                    }

                    if (weeklyData.length >= 3) {
                        // Calculate week-over-week growth rate
                        let totalGrowthRate = 0;
                        let growthPeriods = 0;
                        
                        for (let i = 1; i < weeklyData.length; i++) {
                            if (weeklyData[i - 1] > 0) {
                                totalGrowthRate += (weeklyData[i] - weeklyData[i - 1]) / weeklyData[i - 1];
                                growthPeriods++;
                            }
                        }
                        
                        const avgGrowthRate = growthPeriods > 0 ? totalGrowthRate / growthPeriods : 0;
                        const lastWeek = weeklyData[weeklyData.length - 1];

                        // Forecast next 4 weeks
                        const weeklyForecast = [];
                        let currentWeek = lastWeek;
                        for (let i = 0; i < 4; i++) {
                            currentWeek = currentWeek * (1 + avgGrowthRate);
                            weeklyForecast.push(Math.round(currentWeek));
                        }

                        labels = [...weeklyData.map((_, i) => `Week ${i + 1}`), 'Week +1', 'Week +2', 'Week +3', 'Week +4'];
                        datasets = [
                            {
                                label: 'Historical Weekly',
                                data: [...weeklyData, ...Array(4).fill(null)],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                fill: false
                            },
                            {
                                label: 'Growth Forecast',
                                data: [...Array(weeklyData.length).fill(null), ...weeklyForecast],
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                borderWidth: 3,
                                borderDash: [8, 4],
                                fill: false
                            }
                        ];

                        reasoning = `Based on ${growthPeriods} weeks of data showing ${(avgGrowthRate * 100).toFixed(1)}% average weekly growth rate. ${avgGrowthRate > 0.1 ? 'Strong positive trend' : avgGrowthRate < -0.1 ? 'Declining trend' : 'Stable trend'} detected.`;
                    }
                    break;

                case 'seasonal-patterns':
                    // Analyze day-of-week and monthly patterns
                    const dayOfWeekTotals = new Array(7).fill(0);
                    const dayOfWeekCounts = new Array(7).fill(0);
                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    
                    filteredData.dates.forEach(date => {
                        const dayOfWeek = new Date(date).getDay();
                        const bookings = filteredData.dailyTotals[date].bookings;
                        dayOfWeekTotals[dayOfWeek] += bookings;
                        dayOfWeekCounts[dayOfWeek]++;
                    });
                    
                    const dayOfWeekAvgs = dayOfWeekTotals.map((total, i) => 
                        dayOfWeekCounts[i] > 0 ? total / dayOfWeekCounts[i] : 0
                    );

                    labels = dayNames;
                    datasets = [{
                        label: 'Average Bookings by Day',
                        data: dayOfWeekAvgs,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.5)',
                        borderWidth: 2,
                        fill: true
                    }];

                    const bestDay = dayNames[dayOfWeekAvgs.indexOf(Math.max(...dayOfWeekAvgs))];
                    const worstDay = dayNames[dayOfWeekAvgs.indexOf(Math.min(...dayOfWeekAvgs))];
                    
                    reasoning = `Analysis of ${filteredData.dates.length} days shows ${bestDay} is your strongest day (${Math.round(Math.max(...dayOfWeekAvgs))} avg bookings) and ${worstDay} is weakest (${Math.round(Math.min(...dayOfWeekAvgs))} avg). Use this for marketing timing and inventory planning.`;
                    break;

                case 'supplier-outlook':
                    // Predict which suppliers will grow/decline
                    const supplierPredictions = filteredData.suppliers
                        .map(supplier => {
                            const metrics = filteredData.supplierMetrics[supplier];
                            const totals = filteredData.supplierTotals[supplier];
                            
                            // Predict next week bookings based on trend and consistency
                            const predictedBookings = Math.round(
                                (totals.bookings / Math.max(totals.days, 1) * 7) * // Weekly average
                                (1 + metrics.growthRate) * // Apply growth rate
                                (0.8 + metrics.consistency * 0.4) // Adjust for consistency
                            );
                            
                            return {
                                name: supplier,
                                current: Math.round(totals.bookings / Math.max(totals.days, 1) * 7),
                                predicted: Math.max(0, predictedBookings),
                                confidence: metrics.consistency
                            };
                        })
                        .filter(p => p.current > 10)
                        .sort((a, b) => b.predicted - a.predicted)
                        .slice(0, 10);

                    labels = supplierPredictions.map(p => p.name);
                    datasets = [
                        {
                            label: 'Current Weekly Rate',
                            data: supplierPredictions.map(p => p.current),
                            backgroundColor: '#94a3b8',
                            borderColor: '#64748b',
                            borderWidth: 1
                        },
                        {
                            label: 'Predicted Next Week',
                            data: supplierPredictions.map(p => p.predicted),
                            backgroundColor: supplierPredictions.map(p => 
                                p.predicted > p.current * 1.1 ? '#10b981' : 
                                p.predicted < p.current * 0.9 ? '#ef4444' : '#3b82f6'
                            ),
                            borderColor: '#ffffff',
                            borderWidth: 1
                        }
                    ];

                    const growingCount = supplierPredictions.filter(p => p.predicted > p.current * 1.1).length;
                    const decliningCount = supplierPredictions.filter(p => p.predicted < p.current * 0.9).length;
                    
                    reasoning = `Supplier outlook: ${growingCount} suppliers predicted to grow 10%+, ${decliningCount} to decline 10%+. Predictions based on recent growth trends and historical consistency patterns.`;
                    break;
            }

            if (datasets.length === 0) {
                reasoning = "Insufficient data for this prediction type. Need more historical data.";
                labels = ['No Data'];
                datasets = [{
                    label: 'No Data',
                    data: [0],
                    borderColor: '#94a3b8',
                    backgroundColor: 'rgba(148, 163, 184, 0.1)'
                }];
            }

            document.getElementById('prediction-reasoning').textContent = reasoning;

            charts.predictions = new Chart(ctx, {
                type: currentPredictionType === 'supplier-outlook' ? 'bar' : 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        // SMART OPTIMIZATION WITH DIFFERENT ANALYSES
        function createOptimizationChart() {
            const ctx = document.getElementById('optimizationChart').getContext('2d');
            
            if (charts.optimization) {
                charts.optimization.destroy();
            }

            if (!filteredData.supplierTotals || filteredData.suppliers.length === 0) return;

            let insights = "";

            switch (currentOptimizationType) {
                case 'performance-matrix':
                    const performanceData = filteredData.suppliers
                        .map(supplier => {
                            const totals = filteredData.supplierTotals[supplier];
                            return {
                                x: totals.bookings,
                                y: totals.bookings > 0 ? totals.gmv / totals.bookings : 0,
                                supplier: supplier,
                                gmv: totals.gmv
                            };
                        })
                        .filter(point => point.x > 0);

                    charts.optimization = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: 'Suppliers',
                                data: performanceData,
                                backgroundColor: performanceData.map(point => {
                                    if (point.x > 500 && point.y > 2500) return '#10b981'; // Stars
                                    if (point.x > 500) return '#f59e0b'; // Volume players
                                    if (point.y > 2500) return '#8b5cf6'; // Premium
                                    return '#ef4444'; // Needs improvement
                                }),
                                borderColor: '#ffffff',
                                borderWidth: 2,
                                pointRadius: performanceData.map(point => 
                                    Math.max(6, Math.min(15, Math.sqrt(point.gmv) / 2000))
                                )
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const point = context.raw;
                                            let category = 'Needs Improvement';
                                            if (point.x > 500 && point.y > 2500) category = '‚≠ê Star Performer';
                                            else if (point.x > 500) category = 'üîß Volume Player';
                                            else if (point.y > 2500) category = 'üíé Premium Partner';
                                            
                                            return [
                                                `${point.supplier} (${category})`,
                                                `Volume: ${point.x.toLocaleString()} bookings`,
                                                `Avg Value: ‚Çπ${Math.round(point.y)}`,
                                                `Total GMV: ‚Çπ${Math.round(point.gmv/100000)}L`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Total Bookings (Volume)' },
                                    grid: { color: '#f1f5f9' }
                                },
                                y: {
                                    title: { display: true, text: 'Average Booking Value (‚Çπ)' },
                                    grid: { color: '#f1f5f9' }
                                }
                            }
                        }
                    });

                    const stars = performanceData.filter(p => p.x > 500 && p.y > 2500);
                    const volume = performanceData.filter(p => p.x > 500 && p.y <= 2500);
                    const premium = performanceData.filter(p => p.x <= 500 && p.y > 2500);
                    const improvement = performanceData.filter(p => p.x <= 500 && p.y <= 2500);

                    insights = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: #dcfce7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>‚≠ê Star Performers (${stars.length})</strong><br>
                                High volume + High value<br>
                                Action: Maintain partnership, negotiate better terms
                            </div>
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üîß Volume Players (${volume.length})</strong><br>
                                High volume + Lower value<br>
                                Action: Push for premium inventory or better margins
                            </div>
                            <div style="background: #f3e8ff; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üíé Premium Partners (${premium.length})</strong><br>
                                Lower volume + High value<br>
                                Action: Marketing investment to increase volume
                            </div>
                            <div style="background: #fecaca; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üìà Growth Potential (${improvement.length})</strong><br>
                                Lower volume + Lower value<br>
                                Action: Training, better inventory, or phase out
                            </div>
                        </div>
                    `;
                    break;

                case 'efficiency-analysis':
                    const efficiencyData = filteredData.suppliers
                        .map(supplier => {
                            const totals = filteredData.supplierTotals[supplier];
                            const metrics = filteredData.supplierMetrics[supplier];
                            return {
                                x: metrics.efficiency,
                                y: metrics.consistency,
                                supplier: supplier,
                                bookings: totals.bookings,
                                activeDays: totals.days
                            };
                        })
                        .filter(point => point.x > 0);

                    charts.optimization = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: 'Suppliers',
                                data: efficiencyData,
                                backgroundColor: efficiencyData.map(point => {
                                    if (point.x > 30 && point.y > 0.7) return '#10b981'; // Efficient & Consistent
                                    if (point.x > 30) return '#f59e0b'; // Efficient but inconsistent
                                    if (point.y > 0.7) return '#8b5cf6'; // Consistent but inefficient
                                    return '#ef4444'; // Needs work
                                }),
                                borderColor: '#ffffff',
                                borderWidth: 2,
                                pointRadius: efficiencyData.map(point => 
                                    Math.max(6, Math.min(15, point.bookings / 200))
                                )
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const point = context.raw;
                                            let category = 'Needs Improvement';
                                            if (point.x > 30 && point.y > 0.7) category = 'üöÄ Highly Efficient';
                                            else if (point.x > 30) category = '‚ö° High Output';
                                            else if (point.y > 0.7) category = 'üéØ Reliable';
                                            
                                            return [
                                                `${point.supplier} (${category})`,
                                                `Efficiency: ${point.x.toFixed(1)} bookings/day`,
                                                `Consistency: ${(point.y * 100).toFixed(1)}%`,
                                                `Active Days: ${point.activeDays}`,
                                                `Total Bookings: ${point.bookings.toLocaleString()}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Efficiency (Bookings per Active Day)' },
                                    grid: { color: '#f1f5f9' }
                                },
                                y: {
                                    title: { display: true, text: 'Consistency Score (0-1)' },
                                    grid: { color: '#f1f5f9' },
                                    min: 0,
                                    max: 1
                                }
                            }
                        }
                    });

                    const efficient = efficiencyData.filter(p => p.x > 30 && p.y > 0.7);
                    const highOutput = efficiencyData.filter(p => p.x > 30 && p.y <= 0.7);
                    const reliable = efficiencyData.filter(p => p.x <= 30 && p.y > 0.7);
                    const needsWork = efficiencyData.filter(p => p.x <= 30 && p.y <= 0.7);

                    insights = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: #dcfce7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üöÄ Highly Efficient (${efficient.length})</strong><br>
                                High output + Consistent<br>
                                Action: Model for others, reward with better terms
                            </div>
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>‚ö° High Output (${highOutput.length})</strong><br>
                                High efficiency + Inconsistent<br>
                                Action: Help stabilize operations for better reliability
                            </div>
                            <div style="background: #f3e8ff; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üéØ Reliable (${reliable.length})</strong><br>
                                Consistent + Lower output<br>
                                Action: Training and tools to increase daily capacity
                            </div>
                            <div style="background: #fecaca; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üìà Needs Development (${needsWork.length})</strong><br>
                                Low efficiency + Inconsistent<br>
                                Action: Close monitoring, training, or replacement
                            </div>
                        </div>
                    `;
                    break;

                case 'growth-potential':
                    const growthData = filteredData.suppliers
                        .map(supplier => {
                            const metrics = filteredData.supplierMetrics[supplier];
                            const totals = filteredData.supplierTotals[supplier];
                            return {
                                x: metrics.growthRate * 100, // Convert to percentage
                                y: totals.bookings > 0 ? totals.gmv / totals.bookings : 0,
                                supplier: supplier,
                                bookings: totals.bookings,
                                gmv: totals.gmv
                            };
                        })
                        .filter(point => point.supplier);

                    charts.optimization = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: 'Suppliers',
                                data: growthData,
                                backgroundColor: growthData.map(point => {
                                    if (point.x > 10 && point.y > 2500) return '#10b981'; // Rising stars
                                    if (point.x > 10) return '#f59e0b'; // Fast growers
                                    if (point.y > 2500) return '#8b5cf6'; // High value stable
                                    return point.x < -10 ? '#ef4444' : '#94a3b8'; // Declining or stable
                                }),
                                borderColor: '#ffffff',
                                borderWidth: 2,
                                pointRadius: growthData.map(point => 
                                    Math.max(6, Math.min(15, Math.sqrt(point.bookings) / 5))
                                )
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const point = context.raw;
                                            let category = 'Stable';
                                            if (point.x > 10 && point.y > 2500) category = 'üåü Rising Star';
                                            else if (point.x > 10) category = 'üìà Fast Grower';
                                            else if (point.y > 2500) category = 'üí∞ High Value Stable';
                                            else if (point.x < -10) category = 'üìâ Declining';
                                            
                                            return [
                                                `${point.supplier} (${category})`,
                                                `Growth Rate: ${point.x.toFixed(1)}%`,
                                                `Avg Value: ‚Çπ${Math.round(point.y)}`,
                                                `Total Bookings: ${point.bookings.toLocaleString()}`,
                                                `GMV: ‚Çπ${Math.round(point.gmv/100000)}L`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Weekly Growth Rate (%)' },
                                    grid: { color: '#f1f5f9' }
                                },
                                y: {
                                    title: { display: true, text: 'Average Booking Value (‚Çπ)' },
                                    grid: { color: '#f1f5f9' }
                                }
                            }
                        }
                    });

                    const risingStars = growthData.filter(p => p.x > 10 && p.y > 2500);
                    const fastGrowers = growthData.filter(p => p.x > 10 && p.y <= 2500);
                    const declining = growthData.filter(p => p.x < -10);
                    const stable = growthData.filter(p => p.x >= -10 && p.x <= 10);

                    insights = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: #dcfce7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üåü Rising Stars (${risingStars.length})</strong><br>
                                Fast growth + High value<br>
                                Action: Priority support, increased inventory allocation
                            </div>
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üìà Fast Growers (${fastGrowers.length})</strong><br>
                                High growth + Standard value<br>
                                Action: Help them move upmarket, premium training
                            </div>
                            <div style="background: #fecaca; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üìâ Declining (${declining.length})</strong><br>
                                Negative growth trend<br>
                                Action: Urgent intervention, identify root causes
                            </div>
                            <div style="background: #f1f5f9; padding: 1rem; border-radius: 0.5rem;">
                                <strong>‚Üí Stable (${stable.length})</strong><br>
                                Steady performance<br>
                                Action: Maintain relationship, look for growth catalysts
                            </div>
                        </div>
                    `;
                    break;

                case 'risk-assessment':
                    const riskData = filteredData.suppliers
                        .map(supplier => {
                            const metrics = filteredData.supplierMetrics[supplier];
                            const totals = filteredData.supplierTotals[supplier];
                            
                            // Calculate risk score (higher = riskier)
                            let riskScore = 0;
                            if (metrics.volatility > 0.5) riskScore += 30; // High volatility
                            if (metrics.growthRate < -0.15) riskScore += 25; // Declining
                            if (totals.days < 10) riskScore += 20; // Low activity
                            if (metrics.consistency < 0.3) riskScore += 15; // Inconsistent
                            if (totals.bookings > 0 && totals.gmv / totals.bookings < 1000) riskScore += 10; // Low value
                            
                            return {
                                x: totals.bookings,
                                y: riskScore,
                                supplier: supplier,
                                volatility: metrics.volatility,
                                growth: metrics.growthRate,
                                consistency: metrics.consistency
                            };
                        })
                        .filter(point => point.x > 0);

                    charts.optimization = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: 'Suppliers',
                                data: riskData,
                                backgroundColor: riskData.map(point => {
                                    if (point.y > 60) return '#ef4444'; // High risk
                                    if (point.y > 30) return '#f59e0b'; // Medium risk
                                    return '#10b981'; // Low risk
                                }),
                                borderColor: '#ffffff',
                                borderWidth: 2,
                                pointRadius: riskData.map(point => 
                                    Math.max(6, Math.min(15, point.y / 5 + 5))
                                )
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const point = context.raw;
                                            let riskLevel = 'Low Risk';
                                            if (point.y > 60) riskLevel = 'üî¥ High Risk';
                                            else if (point.y > 30) riskLevel = 'üü° Medium Risk';
                                            else riskLevel = 'üü¢ Low Risk';
                                            
                                            return [
                                                `${point.supplier} (${riskLevel})`,
                                                `Risk Score: ${point.y}/100`,
                                                `Volume: ${point.x.toLocaleString()} bookings`,
                                                `Volatility: ${(point.volatility * 100).toFixed(1)}%`,
                                                `Growth: ${(point.growth * 100).toFixed(1)}%`,
                                                `Consistency: ${(point.consistency * 100).toFixed(1)}%`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Total Bookings (Business Impact)' },
                                    grid: { color: '#f1f5f9' }
                                },
                                y: {
                                    title: { display: true, text: 'Risk Score (0-100)' },
                                    grid: { color: '#f1f5f9' },
                                    min: 0,
                                    max: 100
                                }
                            }
                        }
                    });

                    const highRisk = riskData.filter(p => p.y > 60);
                    const mediumRisk = riskData.filter(p => p.y > 30 && p.y <= 60);
                    const lowRisk = riskData.filter(p => p.y <= 30);
                    const criticalRisk = highRisk.filter(p => p.x > 500); // High risk + High volume

                    insights = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: #fecaca; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üî¥ High Risk (${highRisk.length})</strong><br>
                                Risk score 60+<br>
                                Action: Immediate review, backup plans, close monitoring
                            </div>
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üü° Medium Risk (${mediumRisk.length})</strong><br>
                                Risk score 30-60<br>
                                Action: Regular check-ins, performance improvement plans
                            </div>
                            <div style="background: #dcfce7; padding: 1rem; border-radius: 0.5rem;">
                                <strong>üü¢ Low Risk (${lowRisk.length})</strong><br>
                                Risk score under 30<br>
                                Action: Maintain relationship, consider growth opportunities
                            </div>
                            <div style="background: #f8d7da; padding: 1rem; border-radius: 0.5rem; border: 2px solid #dc3545;">
                                <strong>‚ö†Ô∏è CRITICAL (${criticalRisk.length})</strong><br>
                                High risk + High volume<br>
                                Action: URGENT - These suppliers pose major business risk!
                            </div>
                        </div>
                        ${criticalRisk.length > 0 ? `<div style="background: #f8d7da; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; border: 2px solid #dc3545;">
                            <strong>üö® CRITICAL SUPPLIERS REQUIRING IMMEDIATE ATTENTION:</strong><br>
                            ${criticalRisk.map(p => `${p.supplier} (${p.x} bookings, ${p.y.toFixed(0)} risk score)`).join('<br>')}
                        </div>` : ''}
                    `;
                    break;
            }

            document.getElementById('optimization-insights').innerHTML = insights;
        }

        // CREATE SUPPLIER CARDS WITH SMART CATEGORIZATION
        function createSupplierCards() {
            const container = document.getElementById('supplier-grid');
            container.innerHTML = '';

            if (!filteredData.supplierTotals || filteredData.suppliers.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem; background: white; border-radius: 1rem;">
                        <h3>No suppliers match current filters</h3>
                        <p>Try adjusting your filters to see supplier analysis.</p>
                    </div>
                `;
                return;
            }

            const suppliers = Object.entries(filteredData.supplierTotals)
                .filter(([name]) => filteredData.suppliers.includes(name))
                .map(([name, totals]) => {
                    const metrics = filteredData.supplierMetrics[name];
                    const avgBookingValue = totals.bookings > 0 ? totals.gmv / totals.bookings : 0;
                    const dailyAvg = totals.days > 0 ? totals.bookings / totals.days : 0;
                    
                    // SMART SCORING SYSTEM
                    let score = 0;
                    let tier = 'underperforming';
                    let scoreLabel = 'Needs Work';
                    let insights = [];
                    
                    // Volume score (25 points)
                    if (totals.bookings > 1000) { score += 25; insights.push('High volume'); }
                    else if (totals.bookings > 500) { score += 20; insights.push('Good volume'); }
                    else if (totals.bookings > 200) { score += 15; insights.push('Moderate volume'); }
                    else if (totals.bookings > 50) { score += 10; insights.push('Low volume'); }
                    else insights.push('Very low volume');

                    // Value score (25 points)
                    if (avgBookingValue > 3000) { score += 25; insights.push('Premium value'); }
                    else if (avgBookingValue > 2000) { score += 20; insights.push('High value'); }
                    else if (avgBookingValue > 1500) { score += 15; insights.push('Good value'); }
                    else if (avgBookingValue > 1000) { score += 10; insights.push('Moderate value'); }
                    else insights.push('Low value');

                    // Consistency score (25 points)
                    if (metrics.consistency > 0.8) { score += 25; insights.push('Very consistent'); }
                    else if (metrics.consistency > 0.6) { score += 20; insights.push('Consistent'); }
                    else if (metrics.consistency > 0.4) { score += 15; insights.push('Somewhat consistent'); }
                    else if (metrics.consistency > 0.2) { score += 10; insights.push('Inconsistent'); }
                    else insights.push('Very inconsistent');

                    // Growth score (25 points)
                    if (metrics.growthRate > 0.2) { score += 25; insights.push('Fast growing'); }
                    else if (metrics.growthRate > 0.1) { score += 20; insights.push('Growing'); }
                    else if (metrics.growthRate > 0.05) { score += 15; insights.push('Slow growth'); }
                    else if (metrics.growthRate > -0.05) { score += 10; insights.push('Stable'); }
                    else insights.push('Declining');

                    // Determine tier and label
                    if (score >= 85) { tier = 'top-performer'; scoreLabel = 'Excellent'; }
                    else if (score >= 70) { tier = 'needs-attention'; scoreLabel = 'Very Good'; }
                    else if (score >= 55) { tier = 'needs-attention'; scoreLabel = 'Good'; }
                    else if (score >= 40) { tier = 'underperforming'; scoreLabel = 'Fair'; }
                    else { tier = 'underperforming'; scoreLabel = 'Poor'; }
                    
                    return { 
                        name, 
                        totals, 
                        metrics,
                        avgBookingValue, 
                        dailyAvg, 
                        score, 
                        tier, 
                        scoreLabel,
                        insights: insights.slice(0, 2) // Top 2 characteristics
                    };
                })
                .sort((a, b) => b.score - a.score);

            suppliers.forEach(supplier => {
                const card = document.createElement('div');
                card.className = `supplier-card ${supplier.tier}`;
                card.innerHTML = `
                    <div class="supplier-header">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="supplier-score ${supplier.scoreLabel.toLowerCase().replace(' ', '-')}">${supplier.scoreLabel} (${supplier.score})</div>
                    </div>
                    <div class="supplier-stats">
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">${supplier.totals.bookings.toLocaleString()}</div>
                            <div class="supplier-stat-label">Total Bookings</div>
                        </div>
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">‚Çπ${Math.round(supplier.avgBookingValue).toLocaleString()}</div>
                            <div class="supplier-stat-label">Avg Value</div>
                        </div>
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">${supplier.dailyAvg.toFixed(1)}</div>
                            <div class="supplier-stat-label">Daily Avg</div>
                        </div>
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">${(supplier.metrics.consistency * 100).toFixed(0)}%</div>
                            <div class="supplier-stat-label">Consistency</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.8rem; color: #64748b;">
                        <strong>Key traits:</strong> ${supplier.insights.join(', ')}<br>
                        <strong>Growth:</strong> ${supplier.metrics.growthRate >= 0 ? '+' : ''}${(supplier.metrics.growthRate * 100).toFixed(1)}% weekly
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // TAB SWITCHING
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // CHART CONTROLS
        function toggleChartType(type) {
            currentChartType = type;
            document.querySelectorAll('#overview .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createOverviewChart();
        }

        function toggleChartMetric(metric) {
            currentMetric = metric;
            createOverviewChart();
        }

        function smartTrendFilter(filter) {
            currentTrendFilter = filter;
            document.querySelectorAll('#trends .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createTrendsChart();
        }

        function showRealPrediction(type) {
            currentPredictionType = type;
            document.querySelectorAll('#predictions .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createPredictionsChart();
        }

        function showSmartOptimization(type) {
            currentOptimizationType = type;
            document.querySelectorAll('#optimization .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createOptimizationChart();
        }

        // UTILITY FUNCTIONS
        function showLoading() {
            document.querySelectorAll('.metric-value').forEach(el => {
                el.innerHTML = '<div class="spinner"></div>Loading...';
            });
        }

        function hideLoading() {
            // Loading states will be replaced by actual data
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
        }

        function showSuccess(message) {
            const container = document.querySelector('.container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = '‚úÖ ' + message;
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 5000);
        }

        // INITIALIZE DASHBOARD
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ü§ñ Smart AI Analytics Dashboard initializing...');
            loadBookingData();
        });
    </script>
</body>
</html>
