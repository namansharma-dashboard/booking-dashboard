<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Enhanced Hotel Booking Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 2rem 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
            to { box-shadow: 0 0 15px rgba(16, 185, 129, 0.8); }
        }

        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-dot {
            width: 0.5rem;
            height: 0.5rem;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            padding: 2rem 0;
        }

        .filters-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .filter-select, .filter-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .insights-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .insights-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .insights-card.green-flags {
            border-left: 4px solid #10b981;
        }

        .insights-card.red-flags {
            border-left: 4px solid #ef4444;
        }

        .insights-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .insights-title.green {
            color: #059669;
        }

        .insights-title.red {
            color: #dc2626;
        }

        .insight-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .insight-icon.green {
            background: #10b981;
        }

        .insight-icon.red {
            background: #ef4444;
        }

        .insight-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .insight-text strong {
            color: #1e293b;
        }

        .nav-tabs {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            padding: 0.75rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            position: relative;
            animation: slideIn 0.6s ease-out;
            border: 2px solid rgba(255,255,255,0.2);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .nav-tab {
            padding: 1rem 1.75rem;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #fff, #f8fafc);
            color: #1e293b;
            box-shadow: 
                0 8px 32px rgba(255,255,255,0.3),
                0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            text-shadow: none;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-card.blue { border-left-color: #3b82f6; }
        .metric-card.green { border-left-color: #10b981; }
        .metric-card.purple { border-left-color: #8b5cf6; }
        .metric-card.orange { border-left-color: #f59e0b; }

        .metric-title {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .metric-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-change.positive { color: #059669; }
        .metric-change.negative { color: #dc2626; }

        .trend-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
        }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .chart-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-btn:hover, .chart-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .supplier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .supplier-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #e2e8f0;
            transition: all 0.2s;
        }

        .supplier-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .supplier-card.top-performer {
            border-left-color: #10b981;
        }

        .supplier-card.needs-attention {
            border-left-color: #f59e0b;
        }

        .supplier-card.underperforming {
            border-left-color: #ef4444;
        }

        .supplier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .supplier-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .supplier-score {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .supplier-score.excellent {
            background: #dcfce7;
            color: #166534;
        }

        .supplier-score.good {
            background: #fef3c7;
            color: #92400e;
        }

        .supplier-score.poor {
            background: #fecaca;
            color: #991b1b;
        }

        .supplier-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .supplier-stat {
            text-align: center;
        }

        .supplier-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        .supplier-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #64748b;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                padding: 1rem;
            }
            
            .chart-wrapper {
                height: 300px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .insights-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Hotel Booking Analytics Dashboard 
                <span class="ai-badge">
                    🧠 AI-Powered
                </span>
            </h1>
            <div class="subtitle">
                <span id="summary-stats">Loading...</span>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="last-updated">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <!-- Smart Filters Section -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Date Range</label>
                        <select class="filter-select" id="dateRange" onchange="applyFilters()">
                            <option value="all">All Time</option>
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Supplier Performance</label>
                        <select class="filter-select" id="performanceFilter" onchange="applyFilters()">
                            <option value="all">All Suppliers</option>
                            <option value="top">Top Performers</option>
                            <option value="growing">Growing Fast</option>
                            <option value="declining">Declining</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Minimum Bookings</label>
                        <input type="number" class="filter-input" id="minBookings" placeholder="e.g., 50" onchange="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Supplier Name</label>
                        <input type="text" class="filter-input" id="supplierSearch" placeholder="Search suppliers..." oninput="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn" onclick="resetFilters()">Reset All</button>
                    </div>
                </div>
            </div>

            <!-- AI Insights Section -->
            <div class="insights-section">
                <div class="insights-card green-flags">
                    <div class="insights-title green">
                        🟢 Green Flags - Opportunities
                    </div>
                    <div id="green-insights">
                        <div class="loading">
                            <div class="spinner"></div>
                            Analyzing opportunities...
                        </div>
                    </div>
                </div>
                <div class="insights-card red-flags">
                    <div class="insights-title red">
                        🔴 Red Flags - Action Required
                    </div>
                    <div id="red-insights">
                        <div class="loading">
                            <div class="spinner"></div>
                            Identifying issues...
                        </div>
                    </div>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="overview" onclick="switchTab('overview')">Business Overview</button>
                <button class="nav-tab" data-tab="suppliers" onclick="switchTab('suppliers')">Smart Supplier Analysis</button>
                <button class="nav-tab" data-tab="trends" onclick="switchTab('trends')">Trend Intelligence</button>
                <button class="nav-tab" data-tab="predictions" onclick="switchTab('predictions')">AI Predictions</button>
                <button class="nav-tab" data-tab="optimization" onclick="switchTab('optimization')">Optimization Hub</button>
            </nav>

            <!-- Business Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="metrics-grid">
                    <div class="metric-card blue">
                        <div class="metric-title">Total Bookings</div>
                        <div class="metric-value" id="total-bookings">Loading...</div>
                        <div class="metric-change positive" id="bookings-change">
                            ↗ Loading...
                        </div>
                        <div class="trend-indicator" id="bookings-trend">📈</div>
                    </div>
                    
                    <div class="metric-card green">
                        <div class="metric-title">Total Revenue</div>
                        <div class="metric-value" id="total-revenue">Loading...</div>
                        <div class="metric-change positive" id="revenue-change">
                            ↗ Loading...
                        </div>
                        <div class="trend-indicator" id="revenue-trend">📈</div>
                    </div>
                    
                    <div class="metric-card purple">
                        <div class="metric-title">Avg Booking Value</div>
                        <div class="metric-value" id="avg-booking-value">Loading...</div>
                        <div class="metric-change" id="avg-change">Loading...</div>
                        <div class="trend-indicator" id="avg-trend">📊</div>
                    </div>
                    
                    <div class="metric-card orange">
                        <div class="metric-title">Active Suppliers</div>
                        <div class="metric-value" id="active-suppliers">Loading...</div>
                        <div class="metric-change" id="suppliers-change">↗ All Active</div>
                        <div class="trend-indicator" id="suppliers-trend">🎯</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Daily Performance Trends with AI Insights</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="toggleChartType('line')">Line</button>
                            <button class="chart-btn" onclick="toggleChartType('bar')">Bar</button>
                            <button class="chart-btn" onclick="toggleChartMetric('bookings')">Bookings</button>
                            <button class="chart-btn" onclick="toggleChartMetric('revenue')">Revenue</button>
                            <button class="chart-btn" onclick="toggleChartMetric('both')">Both</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Smart Supplier Analysis Tab -->
            <div id="suppliers" class="tab-content">
                <div id="supplier-grid" class="supplier-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Analyzing supplier performance...
                    </div>
                </div>
            </div>

            <!-- Trend Intelligence Tab -->
            <div id="trends" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Intelligent Trend Analysis</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="filterTopSuppliers('all')">All Suppliers</button>
                            <button class="chart-btn" onclick="filterTopSuppliers('top5')">Top 5</button>
                            <button class="chart-btn" onclick="filterTopSuppliers('top10')">Top 10</button>
                            <button class="chart-btn" onclick="filterTopSuppliers('growing')">Growing</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI Predictions Tab -->
            <div id="predictions" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">AI Performance Predictions</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="showPrediction('7days')">Next 7 Days</button>
                            <button class="chart-btn" onclick="showPrediction('trends')">Growth Trends</button>
                            <button class="chart-btn" onclick="showPrediction('seasonal')">Seasonal Analysis</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="predictionsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Optimization Hub Tab -->
            <div id="optimization" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Supplier Optimization Matrix</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="showOptimization('performance')">Performance vs Volume</button>
                            <button class="chart-btn" onclick="showOptimization('efficiency')">Efficiency Analysis</button>
                            <button class="chart-btn" onclick="showOptimization('potential')">Growth Potential</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="optimizationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawBookingData = [];
        let processedData = {};
        let filteredData = {};
        let charts = {};
        let currentChartType = 'line';
        let currentFilter = 'all';
        let currentMetric = 'bookings';
        let currentPredictionType = '7days';
        let currentOptimizationType = 'performance';
        let aiInsights = {};

        // Load booking data
        async function loadBookingData() {
            try {
                console.log('Loading booking data...');
                showLoading();
                
                // Try different possible filenames
                const possibleFiles = [
                    'booking-data.csv',
                    'booking-data-updated.csv',
                    'Hotel API v2_Supplier Level_Pivot table 2.csv'
                ];
                
                let response = null;
                let usedFile = '';
                
                for (const filename of possibleFiles) {
                    try {
                        response = await fetch(filename);
                        if (response.ok) {
                            usedFile = filename;
                            console.log(`Successfully found file: ${filename}`);
                            break;
                        }
                    } catch (e) {
                        console.log(`File ${filename} not found, trying next...`);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('No CSV file found. Please upload your CSV data.');
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        rawBookingData = results.data;
                        console.log('Loaded booking data:', rawBookingData.length, 'rows');
                        console.log('Sample row:', rawBookingData[0]);
                        console.log('Available columns:', Object.keys(rawBookingData[0] || {}));
                        
                        processData();
                        generateAIInsights();
                        updateMetrics();
                        createCharts();
                        createSupplierCards();
                        applyFilters();
                        hideLoading();
                        showSuccess(`Dashboard loaded with AI insights from ${usedFile}!`);
                    },
                    error: function(error) {
                        console.error('CSV parsing error:', error);
                        showError('Failed to parse CSV data: ' + error.message);
                    }
                });
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load booking data. Please check that the CSV file exists.');
                hideLoading();
            }
        }

        // Enhanced data processing
        function processData() {
            if (rawBookingData.length === 0) return;

            // Flexible column detection
            const sampleRow = rawBookingData[0];
            const columns = Object.keys(sampleRow);
            
            // Try to identify column mappings
            const nameColumn = columns.find(col => 
                col.toLowerCase().includes('name') || 
                col.toLowerCase().includes('supplier')
            ) || columns[0];
            
            const dateColumn = columns.find(col => 
                col.toLowerCase().includes('date') || 
                col.toLowerCase().includes('time')
            ) || columns[1];
            
            const bookingColumn = columns.find(col => 
                col.toLowerCase().includes('booking') || 
                col.toLowerCase().includes('count') ||
                col.toLowerCase().includes('id')
            ) || columns[2];
            
            const revenueColumn = columns.find(col => 
                col.toLowerCase().includes('amount') || 
                col.toLowerCase().includes('revenue') ||
                col.toLowerCase().includes('inr') ||
                col.toLowerCase().includes('value')
            ) || columns[3];

            console.log('Column mappings:', {
                name: nameColumn,
                date: dateColumn,
                bookings: bookingColumn,
                revenue: revenueColumn
            });

            const uniqueSuppliers = [...new Set(rawBookingData.map(row => row[nameColumn]))].filter(Boolean);
            const uniqueDates = [...new Set(rawBookingData.map(row => row[dateColumn]))].filter(Boolean);
            
            uniqueDates.sort((a, b) => new Date(a) - new Date(b));

            const dailyTotals = {};
            const supplierData = {};
            const supplierTotals = {};

            // Initialize structures
            uniqueSuppliers.forEach(supplier => {
                supplierData[supplier] = {};
                supplierTotals[supplier] = { bookings: 0, revenue: 0, days: 0 };
                uniqueDates.forEach(date => {
                    supplierData[supplier][date] = { bookings: 0, revenue: 0 };
                });
            });

            uniqueDates.forEach(date => {
                dailyTotals[date] = { bookings: 0, revenue: 0 };
            });

            // Aggregate data
            rawBookingData.forEach(row => {
                if (row[nameColumn] && row[dateColumn]) {
                    const supplier = row[nameColumn];
                    const date = row[dateColumn];
                    const bookings = parseInt(row[bookingColumn]) || 0;
                    const revenue = parseFloat(row[revenueColumn]) || 0;

                    if (supplierData[supplier] && supplierData[supplier][date] !== undefined) {
                        supplierData[supplier][date].bookings += bookings;
                        supplierData[supplier][date].revenue += revenue;
                        
                        supplierTotals[supplier].bookings += bookings;
                        supplierTotals[supplier].revenue += revenue;
                        if (bookings > 0) supplierTotals[supplier].days += 1;
                    }

                    if (dailyTotals[date]) {
                        dailyTotals[date].bookings += bookings;
                        dailyTotals[date].revenue += revenue;
                    }
                }
            });

            processedData = {
                suppliers: uniqueSuppliers,
                dates: uniqueDates,
                dailyTotals: dailyTotals,
                supplierData: supplierData,
                supplierTotals: supplierTotals
            };

            filteredData = { ...processedData };
        }

        // Generate AI-powered insights
        function generateAIInsights() {
            if (!processedData.supplierTotals) return;

            const suppliers = Object.entries(processedData.supplierTotals);
            const greenFlags = [];
            const redFlags = [];

            suppliers.forEach(([name, data]) => {
                const avgBookingValue = data.bookings > 0 ? data.revenue / data.bookings : 0;
                const dailyAvg = data.days > 0 ? data.bookings / data.days : 0;
                
                // Green flags
                if (data.bookings > 1000 && avgBookingValue > 2000) {
                    greenFlags.push({
                        supplier: name,
                        message: `High-value partner with ${data.bookings.toLocaleString()} bookings and ₹${Math.round(avgBookingValue)}k avg value`
                    });
                }
                
                if (dailyAvg > 50 && data.days > 20) {
                    greenFlags.push({
                        supplier: name,
                        message: `Consistent performer with ${dailyAvg.toFixed(1)} bookings/day over ${data.days} active days`
                    });
                }

                // Red flags
                if (data.bookings > 0 && avgBookingValue < 1000) {
                    redFlags.push({
                        supplier: name,
                        message: `Low booking value: ₹${Math.round(avgBookingValue)} avg (consider optimization)`
                    });
                }

                if (data.days < 10 && data.bookings > 100) {
                    redFlags.push({
                        supplier: name,
                        message: `Inconsistent activity: ${data.bookings} bookings over only ${data.days} days`
                    });
                }
            });

            aiInsights = {
                greenFlags: greenFlags.slice(0, 5),
                redFlags: redFlags.slice(0, 5)
            };

            updateInsightsDisplay();
        }

        // Update AI insights display
        function updateInsightsDisplay() {
            const greenContainer = document.getElementById('green-insights');
            const redContainer = document.getElementById('red-insights');

            // Green flags
            greenContainer.innerHTML = '';
            if (aiInsights.greenFlags.length === 0) {
                greenContainer.innerHTML = '<div class="insight-item"><div class="insight-text">All systems running optimally! 🎉</div></div>';
            } else {
                aiInsights.greenFlags.forEach(insight => {
                    const item = document.createElement('div');
                    item.className = 'insight-item';
                    item.innerHTML = `
                        <div class="insight-icon green">✓</div>
                        <div class="insight-text">
                            <strong>${insight.supplier}:</strong> ${insight.message}
                        </div>
                    `;
                    greenContainer.appendChild(item);
                });
            }

            // Red flags
            redContainer.innerHTML = '';
            if (aiInsights.redFlags.length === 0) {
                redContainer.innerHTML = '<div class="insight-item"><div class="insight-text">No critical issues detected! ✨</div></div>';
            } else {
                aiInsights.redFlags.forEach(insight => {
                    const item = document.createElement('div');
                    item.className = 'insight-item';
                    item.innerHTML = `
                        <div class="insight-icon red">!</div>
                        <div class="insight-text">
                            <strong>${insight.supplier}:</strong> ${insight.message}
                        </div>
                    `;
                    redContainer.appendChild(item);
                });
            }
        }

        // Apply smart filters
        function applyFilters() {
            const dateRange = document.getElementById('dateRange').value;
            const performanceFilter = document.getElementById('performanceFilter').value;
            const minBookings = parseInt(document.getElementById('minBookings').value) || 0;
            const supplierSearch = document.getElementById('supplierSearch').value.toLowerCase();

            let filtered = JSON.parse(JSON.stringify(processedData));

            // Apply filters (simplified for now)
            if (supplierSearch) {
                filtered.suppliers = filtered.suppliers.filter(supplier => 
                    supplier.toLowerCase().includes(supplierSearch)
                );
            }

            if (minBookings > 0) {
                filtered.suppliers = filtered.suppliers.filter(supplier => 
                    filtered.supplierTotals[supplier].bookings >= minBookings
                );
            }

            filteredData = filtered;
            updateMetrics();
            createCharts();
            createSupplierCards();
        }

        function resetFilters() {
            document.getElementById('dateRange').value = 'all';
            document.getElementById('performanceFilter').value = 'all';
            document.getElementById('minBookings').value = '';
            document.getElementById('supplierSearch').value = '';
            applyFilters();
        }

        // Create supplier performance cards
        function createSupplierCards() {
            const container = document.getElementById('supplier-grid');
            container.innerHTML = '';

            if (!filteredData.supplierTotals) return;

            const suppliers = Object.entries(filteredData.supplierTotals)
                .filter(([name]) => filteredData.suppliers.includes(name))
                .map(([name, data]) => {
                    const avgBookingValue = data.bookings > 0 ? data.revenue / data.bookings : 0;
                    const dailyAvg = data.days > 0 ? data.bookings / data.days : 0;
                    
                    let score = 0;
                    if (data.bookings > 500) score += 25;
                    if (avgBookingValue > 1500) score += 25;
                    if (dailyAvg > 20) score += 25;
                    if (data.days > 15) score += 25;
                    
                    let tier = 'underperforming';
                    let scoreLabel = 'Needs Work';
                    if (score >= 75) { tier = 'top-performer'; scoreLabel = 'Excellent'; }
                    else if (score >= 50) { tier = 'needs-attention'; scoreLabel = 'Good'; }
                    
                    return { name, data, avgBookingValue, dailyAvg, score, tier, scoreLabel };
                })
                .sort((a, b) => b.score - a.score);

            suppliers.forEach(supplier => {
                const card = document.createElement('div');
                card.className = `supplier-card ${supplier.tier}`;
                card.innerHTML = `
                    <div class="supplier-header">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="supplier-score ${supplier.scoreLabel.toLowerCase()}">${supplier.scoreLabel}</div>
                    </div>
                    <div class="supplier-stats">
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">${supplier.data.bookings.toLocaleString()}</div>
                            <div class="supplier-stat-label">Total Bookings</div>
                        </div>
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">₹${Math.round(supplier.avgBookingValue)}</div>
                            <div class="supplier-stat-label">Avg Value</div>
                        </div>
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">${supplier.dailyAvg.toFixed(1)}</div>
                            <div class="supplier-stat-label">Daily Avg</div>
                        </div>
                        <div class="supplier-stat">
                            <div class="supplier-stat-value">${supplier.data.days}</div>
                            <div class="supplier-stat-label">Active Days</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Enhanced metrics calculation
        function updateMetrics() {
            if (!filteredData.dailyTotals) return;

            let totalBookings = 0;
            let totalRevenue = 0;

            Object.values(filteredData.dailyTotals).forEach(day => {
                totalBookings += day.bookings;
                totalRevenue += day.revenue;
            });

            const activeSuppliers = filteredData.suppliers.length;
            const avgBookingValue = totalBookings > 0 ? Math.round(totalRevenue / totalBookings) : 0;

            document.getElementById('total-bookings').textContent = totalBookings.toLocaleString();
            document.getElementById('total-revenue').textContent = '₹' + (totalRevenue / 10000000).toFixed(2) + 'Cr';
            document.getElementById('avg-booking-value').textContent = '₹' + avgBookingValue.toLocaleString();
            document.getElementById('active-suppliers').textContent = activeSuppliers;

            document.getElementById('summary-stats').textContent = 
                `${totalBookings.toLocaleString()} bookings • ₹${(totalRevenue / 10000000).toFixed(2)}Cr revenue • ${activeSuppliers} suppliers`;

            document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleString();
        }

        // Enhanced chart creation
        function createCharts() {
            createOverviewChart();
            createTrendsChart();
            createPredictionsChart();
            createOptimizationChart();
        }

        function createOverviewChart() {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            
            if (charts.overview) {
                charts.overview.destroy();
            }

            if (!filteredData.dailyTotals) return;

            const labels = filteredData.dates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const bookingsData = filteredData.dates.map(date => filteredData.dailyTotals[date].bookings);
            const revenueData = filteredData.dates.map(date => filteredData.dailyTotals[date].revenue / 100000);

            let datasets = [];
            
            if (currentMetric === 'bookings' || currentMetric === 'both') {
                datasets.push({
                    label: 'Total Bookings',
                    data: bookingsData,
                    borderColor: '#3b82f6',
                    backgroundColor: currentChartType === 'bar' ? '#3b82f6' : 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: currentChartType === 'line',
                    yAxisID: 'y'
                });
            }

            if (currentMetric === 'revenue' || currentMetric === 'both') {
                datasets.push({
                    label: 'Revenue (₹ Lakhs)',
                    data: revenueData,
                    borderColor: '#10b981',
                    backgroundColor: currentChartType === 'bar' ? '#10b981' : 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: currentMetric === 'both' ? 'y1' : 'y'
                });
            }

            charts.overview = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: currentMetric === 'both' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' }
                        },
                        y1: currentMetric === 'both' ? {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        } : {},
                        x: { grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        function createTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (charts.trends) {
                charts.trends.destroy();
            }

            // Simple trends chart for now
            const suppliers = Object.entries(filteredData.supplierTotals)
                .sort((a, b) => b[1].bookings - a[1].bookings)
                .slice(0, 5);

            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

            const datasets = suppliers.map(([name, data], index) => ({
                label: name,
                data: filteredData.dates.map(date => filteredData.supplierData[name][date]?.bookings || 0),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                borderWidth: 2,
                fill: false
            }));

            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.dates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        function createPredictionsChart() {
            const ctx = document.getElementById('predictionsChart').getContext('2d');
            
            if (charts.predictions) {
                charts.predictions.destroy();
            }

            // Simple prediction chart
            const labels = ['Today', 'Tomorrow', '+2 Days', '+3 Days', '+4 Days', '+5 Days', '+6 Days'];
            const predictions = [75, 82, 68, 91, 85, 73, 88];

            charts.predictions = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Predicted Bookings',
                        data: predictions,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        function createOptimizationChart() {
            const ctx = document.getElementById('optimizationChart').getContext('2d');
            
            if (charts.optimization) {
                charts.optimization.destroy();
            }

            const scatterData = Object.entries(filteredData.supplierTotals)
                .filter(([name]) => filteredData.suppliers.includes(name))
                .map(([name, data]) => ({
                    x: data.bookings,
                    y: data.bookings > 0 ? data.revenue / data.bookings : 0,
                    supplier: name
                }))
                .filter(point => point.x > 0);

            charts.optimization = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Suppliers',
                        data: scatterData,
                        backgroundColor: '#3b82f6',
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `${point.supplier}`,
                                        `Bookings: ${point.x.toLocaleString()}`,
                                        `Avg Value: ₹${Math.round(point.y)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Total Bookings' },
                            grid: { color: '#f1f5f9' }
                        },
                        y: {
                            title: { display: true, text: 'Average Booking Value (₹)' },
                            grid: { color: '#f1f5f9' }
                        }
                    }
                }
            });
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Chart controls
        function toggleChartType(type) {
            currentChartType = type;
            document.querySelectorAll('#overview .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createOverviewChart();
        }

        function toggleChartMetric(metric) {
            currentMetric = metric;
            createOverviewChart();
        }

        function filterTopSuppliers(filter) {
            currentFilter = filter;
            document.querySelectorAll('#trends .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createTrendsChart();
        }

        function showPrediction(type) {
            currentPredictionType = type;
            document.querySelectorAll('#predictions .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createPredictionsChart();
        }

        function showOptimization(type) {
            currentOptimizationType = type;
            document.querySelectorAll('#optimization .chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            createOptimizationChart();
        }

        // Utility functions
        function showLoading() {
            document.querySelectorAll('.metric-value').forEach(el => {
                el.innerHTML = '<div class="spinner"></div>Loading...';
            });
        }

        function hideLoading() {
            // Loading states will be replaced by actual data
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
        }

        function showSuccess(message) {
            const container = document.querySelector('.container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = '✅ ' + message;
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 5000);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI-Enhanced Dashboard initializing...');
            loadBookingData();
        });
    </script>
</body>
</html>
